<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MyStation Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js" defer></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        [data-lucide] { 
            width: 1rem; 
            height: 1rem; 
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.7);
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: rgba(107, 114, 128, 0.5);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(107, 114, 128, 0.7);
        }
        [x-cloak] { display: none !important; }

        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            /* Stili specifici per la stampa */
            .printable-area {
                background: white !important;
                color: black !important;
                font-size: 12px;
            }
            .printable-area table {
                width: 100%;
                border-collapse: collapse;
            }
            .printable-area th, .printable-area td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
            }
            .printable-area th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
            }
            /* Stili per la lista clienti */
            .client-cards-print {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
                margin-top: 1rem;
            }
            .client-card-print {
                border: 1px solid #000;
                padding: 0.5rem;
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .contact-cards-print {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-top: 1rem;
            }
            .contact-card-print {
                border: 1px solid #000;
                padding: 0.5rem;
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>

    <script>
        function dashboardApp() { 
            const IPERSELF_EXTRA_MARKUP = 0.005;
            const SERVITO_MARKUP = 0.210;
            const SERVITO_EXTRA_MARKUP = 0.015;

            return { 
                title: 'MyStation', 
                activeSection: 'home', 
                isMobileMenuOpen: false, 
                isNuovoCaricoModalOpen: false, 
                isDarkMode: false,
                isSidebarCollapsed: false,
                isFullscreen: false,
                isNuovoListinoModalOpen: false,
                isConcorrenzaModalOpen: false,
                isNuovoClienteModalOpen: false,
                isContoClienteModalOpen: false,
                isStoricoClienteModalOpen: false,
                isNuovoTurnoModalOpen: false,
                isNotificationModalOpen: false,
                notificationMessage: '',
                isConfirmationModalOpen: false,
                confirmationMessage: '',
                confirmationCallback: null,
                currentYear: new Date().getFullYear(), 
                searchQuery: '', 
                adminSearchQuery: '',
                registryEntries: [], 
                priceHistory: [],
                clients: [],
                turni: [],
                contacts: [], 
                isNewContactModalOpen: false,
                isGestisciEtichetteModalOpen: false,
                newContact: null,
                editingContact: null,
                contactSearchQuery: '',
                contactFilter: 'all',
                contactLabels: [],
                newLabel: { name: '', color: '#3b82f6' },
                availableColors: [
                    { name: 'Blu', value: '#3b82f6' }, { name: 'Verde', value: '#10b981' },
                    { name: 'Rosso', value: '#ef4444' }, { name: 'Giallo', value: '#f59e0b' },
                    { name: 'Viola', value: '#8b5cf6' }
                ],
                newEntry: null, editingEntry: null, newPriceList: null,
                editingPrice: null, newCompetitorPrices: null, newClient: null,
                editingClient: null, contoCliente: null, newTransaction: null,
                editingTransaction: null, newTurno: null, editingTurno: null,
                recommendedPrices: null, competitorPrices: null, adbluePrice: 0,
                adminFilter: 'all', showAdminContent: true,
                summary: {
                    previousYear: { benzina: 0, gasolio: 0, dieselPlus: 0, hvolution: 0 }
                },
                isStatsMonthDropdownOpen: false,
                MONTH_NAMES: ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'],
                
                // *** INIZIO CORREZIONE: SPOSTAMENTO FUNZIONI HELPER ***
                toLocalDateString(date) {
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                },
                
                parseItalianDate(itDate) {
                    if (!itDate || typeof itDate !== 'string') return new Date();
                    const parts = itDate.split('-');
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                },

                formatDisplayDate(dateString) {
                    if (!dateString) return '-';
                    const [year, month, day] = dateString.split('-');
                    return `${day}-${month}-${year}`;
                },
                // *** FINE CORREZIONE ***

                get sortedTransactions() {
                    if (!this.contoCliente || !this.contoCliente.transactions) return [];
                    return [...this.contoCliente.transactions].sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        return dateB - dateA;
                    });
                },

                saveState() {
                    const state = {
                        registryEntries: this.registryEntries,
                        priceHistory: this.priceHistory,
                        clients: this.clients,
                        turni: this.turni,
                        contacts: this.contacts,
                        contactLabels: this.contactLabels,
                        summary: this.summary,
                        recommendedPrices: this.recommendedPrices,
                        competitorPrices: this.competitorPrices,
                        adbluePrice: this.adbluePrice,
                        isDarkMode: this.isDarkMode,
                        isSidebarCollapsed: this.isSidebarCollapsed,
                    };
                    localStorage.setItem('myStationDashboardState', JSON.stringify(state));
                },

                loadState() {
                    const savedState = localStorage.getItem('myStationDashboardState');
                    if (savedState) {
                        try {
                            const state = JSON.parse(savedState);
                            this.registryEntries = state.registryEntries || [];
                            this.priceHistory = state.priceHistory || [];
                            this.clients = state.clients || [];
                            this.turni = state.turni || [];
                            this.contacts = state.contacts || [];
                            this.contactLabels = state.contactLabels || [{ id: 'lavoro', name: 'Lavoro', color: '#10b981' }, { id: 'personale', name: 'Personale', color: '#3b82f6' }];
                            this.summary = state.summary || { previousYear: { benzina: 0, gasolio: 0, dieselPlus: 0, hvolution: 0 }};
                            this.recommendedPrices = state.recommendedPrices || null;
                            this.competitorPrices = state.competitorPrices || null;
                            this.adbluePrice = state.adbluePrice || 0;
                            this.isDarkMode = state.isDarkMode === true;
                            this.isSidebarCollapsed = state.isSidebarCollapsed === true;
                        } catch (e) {
                            console.error("Errore caricando lo stato, ripristino dati di default.", e);
                            localStorage.removeItem('myStationDashboardState');
                        }
                    }
                },
                
                init() { 
                    this.loadState();
                    this.resetNewEntry();
                    this.resetNewPriceList();
                    this.resetNewCompetitorPrices();
                    this.resetNewClient();
                    this.resetNewTransaction();
                    this.resetNewTurno();
                    this.resetNewContact();
                    this.updateTheme();
                    document.addEventListener('fullscreenchange', () => { this.isFullscreen = !!document.fullscreenElement; });
                    this.$watch('registryEntries', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('priceHistory', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('filteredClients', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('contoCliente', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('turni', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('contacts', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('contactLabels', () => this.$nextTick(() => lucide.createIcons()));
                    this.$nextTick(() => lucide.createIcons());
                    let litriChartInstance, rapportoChartInstance, andamentoChartInstance;
                    const createCharts = () => {
                        if (!document.getElementById('litriChart')) return;
                        const color = this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                        Chart.defaults.color = color;
                        const ctxLitri = document.getElementById('litriChart').getContext('2d');
                        litriChartInstance = new Chart(ctxLitri, { type: 'bar', data: { labels: [], datasets: [{ label: 'Litri Venduti', data: [], backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false }});
                        const ctxRapporto = document.getElementById('rapportoChart').getContext('2d');
                        rapportoChartInstance = new Chart(ctxRapporto, { type: 'doughnut', data: { labels: ['Iperself', 'Servito'], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                        const ctxAndamento = document.getElementById('andamentoChart').getContext('2d');
                        andamentoChartInstance = new Chart(ctxAndamento, { type: 'line', data: { labels: [], datasets: [{ label: 'Litri Totali', data: [], borderColor: '#10b981', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false } });
                    };
                    
                    this.$watch('activeSection', (newSection) => {
                        if (newSection === 'statistiche' && !litriChartInstance) {
                            this.$nextTick(() => createCharts());
                        }
                    });

                    this.$watch('statsData', (newData) => {
                        if (!litriChartInstance || !newData) return;
                        const prodottiLabels = Object.keys(newData.breakdownProdotti).map(p => p.charAt(0).toUpperCase() + p.slice(1).replace('Plus', '+'));
                        const prodottiData = Object.values(newData.breakdownProdotti);
                        litriChartInstance.data.labels = prodottiLabels;
                        litriChartInstance.data.datasets[0].data = prodottiData;
                        litriChartInstance.update();
                        rapportoChartInstance.data.datasets[0].data = [newData.iperselfVsServito.iperself, newData.iperselfVsServito.servito];
                        rapportoChartInstance.update();
                        andamentoChartInstance.data.labels = newData.andamentoVendite.labels;
                        andamentoChartInstance.data.datasets[0].data = newData.andamentoVendite.data;
                        andamentoChartInstance.update();
                    });
                    this.$watch('isDarkMode', () => {
                        const color = this.isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                        Chart.defaults.color = color;
                        if(litriChartInstance) {
                            litriChartInstance.update();
                            rapportoChartInstance.update();
                            andamentoChartInstance.update();
                        }
                    });
                },

                showNotification(message) { this.notificationMessage = message; this.isNotificationModalOpen = true; },
                showConfirmation(message, callback) { this.confirmationMessage = message; this.confirmationCallback = callback; this.isConfirmationModalOpen = true; },
                confirmAction() { if (this.confirmationCallback) { this.confirmationCallback(); } this.isConfirmationModalOpen = false; },
                updateTheme() { document.documentElement.classList.toggle('dark', this.isDarkMode); this.saveState(); },
                toggleFullscreen() { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch((err) => { this.showNotification(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`); }); } else if (document.exitFullscreen) { document.exitFullscreen(); } },
                get summaryTotals() { if (!this.registryEntries || !this.summary || !this.summary.previousYear) { return { items: [], grandTotal: { carico: 0, differenza: 0, previousYear: 0, contabile: 0 } }; } const products = ['benzina', 'gasolio', 'dieselPlus', 'hvolution']; const totals = { benzina: {carico:0, differenza:0}, gasolio: {carico:0, differenza:0}, dieselPlus: {carico:0, differenza:0}, hvolution: {carico:0, differenza:0} }; this.registryEntries.forEach(entry => { products.forEach(product => { totals[product].carico += entry[product]?.carico || 0; totals[product].differenza += entry[product]?.differenza || 0; }); }); const summaryData = { items: [], grandTotal: { carico: 0, differenza: 0, previousYear: 0, contabile: 0 }}; products.forEach(product => { const prevYear = this.summary.previousYear[product] || 0; const contabile = totals[product].carico + totals[product].differenza + prevYear; summaryData.items.push({ name: product.charAt(0).toUpperCase() + product.slice(1).replace('Plus', '+'), key: product, carico: totals[product].carico, differenza: totals[product].differenza, previousYear: prevYear, contabile: contabile }); summaryData.grandTotal.carico += totals[product].carico; summaryData.grandTotal.differenza += totals[product].differenza; summaryData.grandTotal.previousYear += prevYear; summaryData.grandTotal.contabile += contabile; }); return summaryData; },
                get topProduct() { const items = this.summaryTotals.items; if (!items || items.length === 0) return { name: '-', amount: 0 }; const top = items.reduce((prev, current) => (prev.carico > current.carico) ? prev : current); return { name: top.name, amount: top.carico }; },
                get topDriver() {
                    if (!this.registryEntries || this.registryEntries.length === 0) return { name: '-', deliveries: 0 };
                    const driverCounts = this.registryEntries.reduce((acc, entry) => {
                        if (entry.autistaName) {
                           acc[entry.autistaName] = (acc[entry.autistaName] || 0) + 1;
                        }
                        return acc;
                    }, {});
                    const topDriverName = Object.keys(driverCounts).reduce((a, b) => driverCounts[a] > driverCounts[b] ? a : b, '');
                    return { name: (topDriverName || '').split(' ').pop(), deliveries: driverCounts[topDriverName] };
                },
                get priceDifferences() { if (!this.recommendedPrices || !this.competitorPrices) return null; const iperselfBenzina = this.recommendedPrices.benzina + IPERSELF_EXTRA_MARKUP; const iperselfGasolio = this.recommendedPrices.gasolio + IPERSELF_EXTRA_MARKUP; return { myoil: { benzina: this.competitorPrices.myoil.benzina - iperselfBenzina, gasolio: this.competitorPrices.myoil.gasolio - iperselfGasolio }, esso: { benzina: this.competitorPrices.esso.benzina - iperselfBenzina, gasolio: this.competitorPrices.esso.gasolio - iperselfGasolio }, q8: { benzina: this.competitorPrices.q8.benzina - iperselfBenzina, gasolio: this.competitorPrices.q8.gasolio - iperselfGasolio } }; },
                get filteredRegistryEntries() { if (!this.searchQuery) return this.registryEntries; return this.registryEntries.filter(entry => { const searchLower = this.searchQuery.toLowerCase(); return (entry.autistaName || '').toLowerCase().includes(searchLower) || (this.formatDate(entry.date) || '').toLowerCase().includes(searchLower); }); },
                formatPrice(value) { if (value === null || value === undefined || value === 0) return '-'; return value.toLocaleString('it-IT', { minimumFractionDigits: 3, maximumFractionDigits: 3 }); },
                formatDifference(value) { if (value === null || value === undefined || !isFinite(value)) return '-'; const sign = value > 0 ? '+' : ''; return sign + value.toLocaleString('it-IT', { minimumFractionDigits: 3, maximumFractionDigits: 3 }); },
                getDifferenceClass(value) { if (value === null || value === undefined || !isFinite(value)) return 'text-gray-500 dark:text-gray-400'; if (value < 0) return 'text-red-600 dark:text-red-400'; if (value > 0) return 'text-green-600 dark:text-green-400'; return 'text-gray-500 dark:text-gray-400'; },
                formatDate(dateString, separator = '/') {
                    if (!dateString || typeof dateString !== 'string' || !dateString.includes('-')) return '-';
                    const parts = dateString.split('-');
                    if (parts.length === 3 && parts[0].length === 4) {
                        const [year, month, day] = parts;
                        return [day, month, year].join(separator);
                    }
                    if (parts.length === 3 && parts[2].length === 4) {
                         const [day, month, year] = parts;
                         return [day, month, year].join(separator);
                    }
                    return dateString;
                },
                toDisplayDate(dateString) { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}-${month}-${year}`; },
                fromDisplayDate(displayDate) { if (!displayDate) return ''; const parts = displayDate.split('-'); if (parts.length === 3 && parts[0].length === 2) { return `${parts[2]}-${parts[1]}-${parts[0]}`; } return displayDate; },
                formatCarico(value) { if (!value && value !== 0) return '-'; return value.toLocaleString('it-IT'); },
                formatCaricoDifferenza(value) { if (value === 0 || value === null || value === undefined) return '-'; return value.toString(); },
                getCaricoDifferenceClass(value) { if (value < 0) return 'text-red-600 dark:text-red-400'; if (value > 0) return 'text-green-600 dark:text-green-400'; return 'text-gray-500 dark:text-gray-400'; },
                resetNewEntry() { this.newEntry = { id: '', date: this.toDisplayDate(this.toLocalDateString(new Date())), autistaName: '', benzina: { carico: null, differenza: null }, gasolio: { carico: null, differenza: null }, dieselPlus: { carico: null, differenza: null }, hvolution: { carico: null, differenza: null }}; },
                openNuovoCaricoModal() { this.editingEntry = null; this.resetNewEntry(); this.isNuovoCaricoModalOpen = true; },
                editEntry(entry) { this.editingEntry = entry; this.newEntry = JSON.parse(JSON.stringify(entry)); this.newEntry.date = this.toDisplayDate(entry.date); this.isNuovoCaricoModalOpen = true; },
                closeNuovoCaricoModal() { this.isNuovoCaricoModalOpen = false; this.editingEntry = null; },
                saveNewEntry() { if (!this.newEntry.autistaName.trim()) { this.showNotification('Per favore, inserisci il nome dell\'autista.'); return; } this.newEntry.date = this.fromDisplayDate(this.newEntry.date); if (this.editingEntry) { const index = this.registryEntries.findIndex(e => e.id === this.editingEntry.id); if (index !== -1) this.registryEntries[index] = this.newEntry; } else { this.newEntry.id = Math.random().toString(36).substring(2); this.registryEntries.unshift(this.newEntry); } this.registryEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); this.closeNuovoCaricoModal(); this.showNotification('Carico salvato con successo!'); this.saveState(); },
                deleteEntry(entryToDelete) { this.showConfirmation('Sei sicuro di voler eliminare questo carico?', () => { this.registryEntries = this.registryEntries.filter(e => e.id !== entryToDelete.id); this.showNotification('Carico eliminato.'); this.saveState(); }); },
                resetNewPriceList() { this.newPriceList = { id: '', date: this.formatDisplayDate(this.toLocalDateString(new Date())), annotazioni: '', benzina: null, dieselPlus: null, gasolio: null, hvolution: null }; },
                openNuovoListinoModal() { this.editingPrice = null; this.resetNewPriceList(); this.isNuovoListinoModalOpen = true; },
                editPrice(price) { this.editingPrice = price; this.newPriceList = JSON.parse(JSON.stringify(price)); this.newPriceList.date = this.formatDisplayDate(price.date); this.isNuovoListinoModalOpen = true; },
                closeNuovoListinoModal() { this.isNuovoListinoModalOpen = false; this.editingPrice = null; },
                saveNewPriceList() { this.newPriceList.date = this.toLocalDateString(this.parseItalianDate(this.newPriceList.date)); if (this.editingPrice) { const index = this.priceHistory.findIndex(p => p.id === this.editingPrice.id); if (index !== -1) this.priceHistory[index] = this.newPriceList; } else { this.newPriceList.id = Math.random().toString(36).substring(2); this.priceHistory.unshift(this.newPriceList); } this.recommendedPrices = JSON.parse(JSON.stringify(this.priceHistory[0])); this.closeNuovoListinoModal(); this.showNotification('Listino prezzi salvato!'); this.saveState(); },
                deletePrice(priceToDelete) { this.showConfirmation('Sei sicuro di voler eliminare questo listino?', () => { this.priceHistory = this.priceHistory.filter(p => p.id !== priceToDelete.id); this.recommendedPrices = this.priceHistory.length > 0 ? this.priceHistory[0] : null; this.showNotification('Listino eliminato.'); this.saveState(); }); },
                resetNewCompetitorPrices() { this.newCompetitorPrices = { date: this.formatDisplayDate(this.toLocalDateString(new Date())), annotazioni: '', myoil: { benzina: null, gasolio: null }, esso: { benzina: null, gasolio: null }, q8: { benzina: null, gasolio: null } }; },
                openConcorrenzaModal() { this.resetNewCompetitorPrices(); this.isConcorrenzaModalOpen = true; },
                closeConcorrenzaModal() { this.isConcorrenzaModalOpen = false; },
                saveCompetitorPrices() { this.newCompetitorPrices.date = this.toLocalDateString(this.parseItalianDate(this.newCompetitorPrices.date)); this.competitorPrices = JSON.parse(JSON.stringify(this.newCompetitorPrices)); this.closeConcorrenzaModal(); this.showNotification('Prezzi concorrenza salvati!'); this.saveState(); },
                getIperselfPrice(product) { if (!this.recommendedPrices) return 0; return this.recommendedPrices[product] + IPERSELF_EXTRA_MARKUP; },
                getServitoPrice(product) { if (!this.recommendedPrices) return 0; return this.recommendedPrices[product] + SERVITO_MARKUP + SERVITO_EXTRA_MARKUP; },
                resetNewClient() { this.newClient = { id: '', name: '', balance: null, transactions: [] }; },
                openNewClientModal() { this.editingClient = null; this.resetNewClient(); this.isNuovoClienteModalOpen = true; },
                editClient(client) { this.editingClient = client; this.newClient = JSON.parse(JSON.stringify(client)); this.isNuovoClienteModalOpen = true; },
                closeNewClientModal() { this.isNuovoClienteModalOpen = false; this.editingClient = null; },
                saveClient() { if (!this.newClient.name.trim()) { this.showNotification('Il nome del cliente è obbligatorio.'); return; } if (this.editingClient) { const index = this.clients.findIndex(c => c.id === this.editingClient.id); if (index !== -1) { this.clients[index].name = this.newClient.name; this.clients[index].balance = this.newClient.balance || 0; } } else { this.newClient.id = Math.random().toString(36).substring(2); this.newClient.balance = this.newClient.balance || 0; this.newClient.transactions = []; this.clients.push(this.newClient); } this.closeNewClientModal(); this.showNotification('Cliente salvato con successo.'); this.saveState(); },
                openContoClienteModal(client) { this.contoCliente = client; this.resetNewTransaction(); this.isContoClienteModalOpen = true; },
                closeContoClienteModal() { this.isContoClienteModalOpen = false; this.contoCliente = null; },
                openStoricoClienteModal() { this.isStoricoClienteModalOpen = true; },
                closeStoricoClienteModal() { this.isStoricoClienteModalOpen = false; },
                resetNewTransaction() { this.newTransaction = { id: '', date: this.toDisplayDate(this.toLocalDateString(new Date())), description: 'Carburante', amount: null }; },
                addTransaction() { const amount = parseFloat(this.newTransaction.amount); if (!amount || isNaN(amount)) { this.showNotification('Inserire un importo valido.'); return; } this.contoCliente.balance -= amount; const transactionToAdd = JSON.parse(JSON.stringify(this.newTransaction)); transactionToAdd.id = Math.random().toString(36).substring(2); transactionToAdd.date = this.fromDisplayDate(transactionToAdd.date); this.contoCliente.transactions.unshift(transactionToAdd); this.resetNewTransaction(); this.showNotification('Transazione aggiunta.'); this.saveState(); },
                addAcconto() { const amount = parseFloat(this.newTransaction.amount); if (!amount || isNaN(amount) || amount <= 0) { this.showNotification('Inserire un importo positivo valido per l\'acconto.'); return; } this.contoCliente.balance += amount; const transactionToAdd = { id: Math.random().toString(36).substring(2), date: this.fromDisplayDate(this.newTransaction.date), description: 'Acconto', amount: amount }; this.contoCliente.transactions.unshift(transactionToAdd); this.resetNewTransaction(); this.showNotification('Acconto registrato.'); this.saveState(); },
                saldaConto() { this.showConfirmation('Sei sicuro di voler saldare il conto? Tutte le transazioni verranno eliminate e il saldo sarà azzerato.', () => { this.contoCliente.balance = 0; this.contoCliente.transactions = []; this.showNotification('Conto saldato con successo.'); this.saveState(); }); },
                editTransaction(tx) { this.editingTransaction = JSON.parse(JSON.stringify(tx)); this.editingTransaction.originalAmount = tx.amount; },
                saveTransaction() { const amountChange = this.editingTransaction.amount - this.editingTransaction.originalAmount; this.contoCliente.balance -= amountChange; const index = this.contoCliente.transactions.findIndex(t => t.id === this.editingTransaction.id); if (index !== -1) { delete this.editingTransaction.originalAmount; this.contoCliente.transactions[index] = this.editingTransaction; } this.editingTransaction = null; this.showNotification('Operazione aggiornata.'); this.saveState(); },
                cancelEditTransaction() { this.editingTransaction = null; },
                deleteTransaction(tx) { this.showConfirmation('Sei sicuro di voler eliminare questa operazione?', () => { this.contoCliente.balance += tx.description === 'Acconto' ? -tx.amount : tx.amount; this.contoCliente.transactions = this.contoCliente.transactions.filter(t => t.id !== tx.id); this.showNotification('Operazione eliminata.'); this.saveState(); }); },
                get activeClients() { return this.clients.length; },
                get totalCredit() { return this.clients.reduce((total, client) => client.balance > 0 ? total + client.balance : total, 0); },
                get totalDebit() { return this.clients.reduce((total, client) => client.balance < 0 ? total + client.balance : total, 0); },
                get filteredClients() {
                    let filtered = this.clients;
                    if (this.adminFilter === 'credit') {
                        filtered = filtered.filter(c => c.balance > 0);
                    } else if (this.adminFilter === 'debit') {
                        filtered = filtered.filter(c => c.balance < 0);
                    }
                    if (this.adminSearchQuery) {
                        const searchLower = this.adminSearchQuery.toLowerCase();
                        filtered = filtered.filter(c => c.name.toLowerCase().includes(searchLower));
                    }
                    return filtered.sort((a, b) => {
                        const lastNameA = (a.name || '').split(' ').pop() || '';
                        const lastNameB = (b.name || '').split(' ').pop() || '';
                        return lastNameA.localeCompare(lastNameB);
                    });
                },
                formatCurrency(value) { if (value === null || value === undefined) return '€ 0,00'; return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value); },
                getClientBalanceClass(balance) { if (balance > 0) return 'text-green-600 dark:text-green-400'; if (balance < 0) return 'text-red-600 dark:text-red-400'; return 'text-gray-500 dark:text-gray-400'; },
                resetNewTurno() { this.newTurno = { id: '', date: this.formatDisplayDate(this.toLocalDateString(new Date())), turno: '', iperself: { gasolio: null, dieselPlus: null, benzina: null, hvolution: null }, servito: { gasolio: null, dieselPlus: null, adblue: null, benzina: null, hvolution: null }}; },
                openNuovoTurnoModal() { this.editingTurno = null; this.resetNewTurno(); this.isNuovoTurnoModalOpen = true; },
                closeNuovoTurnoModal() { this.isNuovoTurnoModalOpen = false; this.editingTurno = null; },
                saveTurno() { this.newTurno.date = this.toLocalDateString(this.parseItalianDate(this.newTurno.date)); if (this.editingTurno) { const index = this.turni.findIndex(t => t.id === this.editingTurno.id); if (index !== -1) this.turni[index] = this.newTurno; } else { this.newTurno.id = Math.random().toString(36).substring(2); this.turni.unshift(this.newTurno); } this.closeNuovoTurnoModal(); this.showNotification('Turno salvato con successo.'); this.saveState(); },
                editTurno(turno) { this.editingTurno = turno; this.newTurno = JSON.parse(JSON.stringify(turno)); this.newTurno.date = this.formatDisplayDate(turno.date); this.isNuovoTurnoModalOpen = true; },
                deleteTurno(turnoToDelete) { this.showConfirmation('Sei sicuro di voler eliminare questo turno?', () => { this.turni = this.turni.filter(t => t.id !== turnoToDelete.id); this.showNotification('Turno eliminato.'); this.saveState(); }); },
                getTurnoTotal(turno, product) { return (turno.iperself[product] || 0) + (turno.servito[product] || 0); },
                get dailyTurnoSummary() {
                    if (!this.turni || this.turni.length === 0) return null;
                    const latestDate = this.turni.map(t => t.date).sort((a,b) => new Date(b) - new Date(a))[0];
                    const turniDelGiorno = this.turni.filter(t => t.date === latestDate);

                    const summary = turniDelGiorno.reduce((acc, turno) => {
                        if (!acc[turno.turno]) {
                            acc[turno.turno] = { totalLiters: 0, date: turno.date };
                        }
                        let turnoTotal = 0;
                        for (const product in turno.iperself) {
                            turnoTotal += parseFloat(turno.iperself[product]) || 0;
                        }
                        for (const product in turno.servito) {
                            turnoTotal += parseFloat(turno.servito[product]) || 0;
                        }
                        acc[turno.turno].totalLiters += turnoTotal;
                        return acc;
                    }, {});

                    if (Object.keys(summary).length === 0) return null;
                    return { date: this.formatDate(latestDate), turni: summary };
                },
                statsFilter: 'giorno', statsDate: new Date().toISOString().slice(0, 10), statsYear: new Date().getFullYear(),
                statsMonth: new Date().getMonth(), statsPeriod: { trimestre: 1, semestre: 1 },
                get filteredTurni() { if (!this.turni || this.turni.length === 0) return []; const currentYear = this.statsYear; return this.turni.filter(turno => { const turnoDate = new Date(turno.date); switch (this.statsFilter) { case 'giorno': return turno.date === this.statsDate; case 'settimana': const today = new Date(); today.setHours(23, 59, 59, 999); const weekAgo = new Date(); weekAgo.setDate(today.getDate() - 7); weekAgo.setHours(0, 0, 0, 0); return turnoDate >= weekAgo && turnoDate <= today; case 'mese': return turnoDate.getFullYear() === currentYear && turnoDate.getMonth() === this.statsMonth; case 'trimestre': const trimestreStartMonth = (this.statsPeriod.trimestre - 1) * 3; const trimestreEndMonth = trimestreStartMonth + 2; return turnoDate.getFullYear() === currentYear && turnoDate.getMonth() >= trimestreStartMonth && turnoDate.getMonth() <= trimestreEndMonth; case 'semestre': const semestreStartMonth = (this.statsPeriod.semestre - 1) * 6; const semestreEndMonth = semestreStartMonth + 5; return turnoDate.getFullYear() === currentYear && turnoDate.getMonth() >= semestreStartMonth && turnoDate.getMonth() <= semestreEndMonth; case 'anno': return turnoDate.getFullYear() === currentYear; default: return false; } }); },
                get statsData() { const data = { litriTotali: 0, fatturato: 0, percentualeServito: 0, prodottoPiuVenduto: { nome: '-', litri: 0 }, breakdownProdotti: { benzina: 0, gasolio: 0, dieselPlus: 0, hvolution: 0, adblue: 0 }, iperselfVsServito: { iperself: 0, servito: 0 }, andamentoVendite: { labels: [], data: [] } }; if (!this.filteredTurni.length) { return data; } const prodotti = ['benzina', 'gasolio', 'dieselPlus', 'hvolution', 'adblue']; const litriPerProdotto = { benzina: 0, gasolio: 0, dieselPlus: 0, hvolution: 0, adblue: 0 }; const venditeGiornaliere = {}; this.filteredTurni.forEach(turno => { let turnoIperself = 0; let turnoServito = 0; const turnoDateStr = turno.date; prodotti.forEach(p => { const litriIperself = parseFloat(turno.iperself[p]) || 0; const litriServito = parseFloat(turno.servito[p]) || 0; litriPerProdotto[p] += litriIperself + litriServito; turnoIperself += litriIperself; turnoServito += litriServito; if (this.recommendedPrices) { const prezzoIperself = p === 'adblue' ? 0 : this.getIperselfPrice(p) || 0; const prezzoServito = p === 'adblue' ? (this.adbluePrice || 0) : this.getServitoPrice(p) || 0; data.fatturato += (litriIperself * prezzoIperself) + (litriServito * prezzoServito); } }); data.iperselfVsServito.iperself += turnoIperself; data.iperselfVsServito.servito += turnoServito; const litriTurno = turnoIperself + turnoServito; venditeGiornaliere[turnoDateStr] = (venditeGiornaliere[turnoDateStr] || 0) + litriTurno; }); data.litriTotali = data.iperselfVsServito.iperself + data.iperselfVsServito.servito; if (data.litriTotali > 0) { data.percentualeServito = (data.iperselfVsServito.servito / data.litriTotali) * 100; } let maxLitri = 0; for (const prodotto in litriPerProdotto) { if (litriPerProdotto[prodotto] > maxLitri) { maxLitri = litriPerProdotto[prodotto]; data.prodottoPiuVenduto = { nome: prodotto.charAt(0).toUpperCase() + prodotto.slice(1).replace('Plus', '+'), litri: maxLitri }; } } data.breakdownProdotti = litriPerProdotto; const sortedDates = Object.keys(venditeGiornaliere).sort((a,b) => new Date(a) - new Date(b)); sortedDates.forEach(date => { data.andamentoVendite.labels.push(this.formatDate(date)); data.andamentoVendite.data.push(venditeGiornaliere[date]); }); return data; },
                resetNewContact() { this.newContact = { id: '', firstName: '', lastName: '', phone: '', organization: '', email: '', notes: '', labels: [] }; },
                openNewContactModal() { this.editingContact = null; this.resetNewContact(); this.isNewContactModalOpen = true; },
                editContact(contact) { this.editingContact = contact; this.newContact = JSON.parse(JSON.stringify(contact)); this.isNewContactModalOpen = true; },
                closeNewContactModal() { this.isNewContactModalOpen = false; this.editingContact = null; },
                saveContact() {
                    if (!this.newContact.lastName.trim()) {
                        this.showNotification('Il cognome è obbligatorio.');
                        return;
                    }
                    if (this.editingContact) {
                        const index = this.contacts.findIndex(c => c.id === this.editingContact.id);
                        if (index !== -1) {
                            this.contacts[index] = this.newContact;
                        }
                    } else {
                        this.newContact.id = Math.random().toString(36).substring(2);
                        this.contacts.unshift(this.newContact);
                    }
                    this.closeNewContactModal();
                    this.showNotification('Contatto salvato con successo!');
                    this.saveState();
                },
                deleteContact(contactToDelete) { this.showConfirmation('Sei sicuro di voler eliminare questo contatto?', () => { this.contacts = this.contacts.filter(c => c.id !== contactToDelete.id); this.showNotification('Contatto eliminato.'); this.saveState(); }); },
                deleteClient(clientToDelete) { this.showConfirmation('Sei sicuro di voler eliminare questo cliente? Tutte le transazioni verranno perse.', () => { this.clients = this.clients.filter(c => c.id !== clientToDelete.id); this.closeNewClientModal(); this.showNotification('Cliente eliminato.'); this.saveState(); }); },
                
                get filteredContacts() {
                    const searchLower = this.contactSearchQuery.toLowerCase();
                    let filtered = this.contacts.filter(contact =>
                        (contact.firstName || '').toLowerCase().includes(searchLower) ||
                        (contact.lastName || '').toLowerCase().includes(searchLower) ||
                        (contact.phone || '').toLowerCase().includes(searchLower) ||
                        (contact.email || '').toLowerCase().includes(searchLower) ||
                        (contact.organization || '').toLowerCase().includes(searchLower)
                    );
                    if (this.contactFilter !== 'all') {
                        filtered = filtered.filter(contact => contact.labels.includes(this.contactFilter));
                    }
                    return filtered.sort((a, b) => (a.lastName || '').localeCompare(b.lastName || ''));
                },

                get searchPlaceholder() {
                    switch (this.activeSection) {
                        case 'amministrazione': return 'Cerca cliente...';
                        case 'anagrafica': return 'Cerca contatto...';
                        case 'registro': case 'home': default: return 'Cerca nel registro...';
                    }
                },

                get currentSearchQuery() {
                    switch (this.activeSection) {
                        case 'amministrazione': return this.adminSearchQuery;
                        case 'anagrafica': return this.contactSearchQuery;
                        default: return this.searchQuery;
                    }
                },
                set currentSearchQuery(value) {
                    switch (this.activeSection) {
                        case 'amministrazione': this.adminSearchQuery = value; break;
                        case 'anagrafica': this.contactSearchQuery = value; break;
                        default: this.searchQuery = value; break;
                    }
                },

                openGestisciEtichetteModal() { this.newLabel = { name: '', color: '#3b82f6' }; this.isGestisciEtichetteModalOpen = true; },
                closeGestisciEtichetteModal() { this.isGestisciEtichetteModalOpen = false; },
                saveNewLabel() { if (!this.newLabel.name.trim()) { this.showNotification('Il nome dell\'etichetta è obbligatorio.'); return; } if (this.contactLabels.length >= 5) { this.showNotification('Hai raggiunto il limite massimo di 5 etichette.'); return; } this.contactLabels.push({ id: this.newLabel.name.toLowerCase().replace(/\s/g, ''), name: this.newLabel.name, color: this.newLabel.color }); this.newLabel = { name: '', color: '#3b82f6' }; this.$nextTick(() => lucide.createIcons()); this.saveState(); },
                deleteLabel(labelId) { this.showConfirmation('Sei sicuro di voler eliminare questa etichetta? Verrà rimossa da tutti i contatti.', () => { this.contacts = this.contacts.map(contact => ({ ...contact, labels: contact.labels.filter(label => label !== labelId) })); this.contactLabels = this.contactLabels.filter(label => label.id !== labelId); this.showNotification('Etichetta eliminata.'); this.saveState(); }); },
                toggleLabel(labelId) { const index = this.newContact.labels.indexOf(labelId); if (index === -1) { this.newContact.labels.push(labelId); } else { this.newContact.labels.splice(index, 1); } },
                getLabelColor(labelId) { return this.contactLabels.find(label => label.id === labelId)?.color || ''; },
                menuItems: [ { id: 'home', label: 'Home', icon: 'home' }, { id: 'anagrafica', label: 'Anagrafica', icon: 'users' }, { id: 'amministrazione', label: 'Amministrazione', icon: 'shield' }, { id: 'registro', label: 'Registro di carico', icon: 'clipboard-list' }, { id: 'prezzi', label: 'Gestione prezzi', icon: 'euro' }, { id: 'virtual', label: 'VirtualStation', icon: 'monitor' }, { id: 'statistiche', label: 'Statistiche', icon: 'bar-chart' } ],
                handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const jsonData = JSON.parse(e.target.result); this.importSectionData(jsonData); } catch (error) { this.showNotification('Errore: il file selezionato non è un JSON valido.'); console.error("Errore nel parsing del JSON:", error); } }; reader.readAsText(file); event.target.value = null; },
                importSectionData(jsonData) {
                    switch(this.activeSection) {
                        case 'registro': if (jsonData.registryEntries && Array.isArray(jsonData.registryEntries)) { this.registryEntries = jsonData.registryEntries.map(entry => { let normalizedDate = entry.date; if (entry.date && typeof entry.date === 'string') { if (entry.date.includes('-') && entry.date.length === 10) { const parts = entry.date.split('-'); if (parts[0].length === 2) { normalizedDate = `${parts[2]}-${parts[1]}-${parts[0]}`; } } } return { id: entry.id || Math.random().toString(36).substring(2), date: normalizedDate, autistaName: entry.autistaName || '', benzina: { carico: parseInt(entry.benzina?.carico) || 0, differenza: parseInt(entry.benzina?.differenza) || 0 }, gasolio: { carico: parseInt(entry.gasolio?.carico) || 0, differenza: parseInt(entry.gasolio?.differenza) || 0 }, dieselPlus: { carico: parseInt(entry.dieselPlus?.carico) || 0, differenza: parseInt(entry.dieselPlus?.differenza) || 0 }, hvolution: { carico: parseInt(entry.hvolution?.carico) || 0, differenza: parseInt(entry.hvolution?.differenza) || 0 } }; }); this.registryEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); this.showNotification(`File importato! Caricati ${this.registryEntries.length} record.`); } else { this.showNotification('Errore: formato file non valido per Registro di carico.'); } break;
                        case 'prezzi': if (jsonData.priceHistory && Array.isArray(jsonData.priceHistory)) { this.priceHistory = jsonData.priceHistory; if (jsonData.competitorPrices) this.competitorPrices = jsonData.competitorPrices; if (jsonData.adbluePrice) this.adbluePrice = jsonData.adbluePrice; this.showNotification(`Prezzi importati! Caricati ${this.priceHistory.length} listini.`); } else { this.showNotification('Errore: formato file non valido per Gestione prezzi.'); } break;
                        case 'amministrazione': if (jsonData.clients && Array.isArray(jsonData.clients)) { this.clients = jsonData.clients; this.showNotification(`Amministrazione importata! Caricati ${this.clients.length} clienti.`); } else { this.showNotification('Errore: formato file non valido per Amministrazione.'); } break;
                        case 'anagrafica':
                            if (jsonData.contacts && Array.isArray(jsonData.contacts)) {
                                this.contacts = jsonData.contacts.map(contact => {
                                    return {
                                        id: contact.id || Math.random().toString(36).substring(2),
                                        firstName: contact.firstName || contact.nome || '',
                                        lastName: contact.lastName || contact.cognome || '',
                                        phone: contact.phone || contact.telefono || '',
                                        organization: contact.organization || contact.azienda || contact.organizzazione || '',
                                        email: contact.email || '',
                                        notes: contact.notes || '',
                                        labels: contact.labels || []
                                    };
                                });
                                if (jsonData.contactLabels && Array.isArray(jsonData.contactLabels)) {
                                    this.contactLabels = jsonData.contactLabels;
                                }
                                this.showNotification(`Anagrafica importata! Caricati ${this.contacts.length} contatti.`);
                                this.$nextTick(() => lucide.createIcons());
                            } else {
                                this.showNotification('Errore: formato file non valido per Anagrafica.');
                            }
                            break;
                        case 'virtual': if (jsonData.turni && Array.isArray(jsonData.turni)) { this.turni = jsonData.turni; this.showNotification(`VirtualStation importata! Caricati ${this.turni.length} turni.`); } else { this.showNotification('Errore: formato file non valido per VirtualStation.'); } break;
                        default: this.showNotification('Impossibile importare dati per questa sezione.');
                    }
                    this.saveState();
                },
                getSectionExportData() { switch(this.activeSection) { case 'registro': return { registryEntries: this.registryEntries }; case 'prezzi': return { priceHistory: this.priceHistory, competitorPrices: this.competitorPrices, adbluePrice: this.adbluePrice }; case 'amministrazione': return { clients: this.clients }; case 'anagrafica': return { contacts: this.contacts, contactLabels: this.contactLabels }; case 'virtual': return { turni: this.turni }; default: return {}; } },
                getSectionFileName() { const date = new Date().toISOString().split('T')[0].replace(/-/g, ''); switch(this.activeSection) { case 'registro': return `registro_${date}.json`; case 'prezzi': return `prezzi_${date}.json`; case 'amministrazione': return `amministrazione_${date}.json`; case 'anagrafica': return `anagrafica_${date}.json`; case 'virtual': return `virtual_${date}.json`; default: return `dati_${date}.json`; } },
                setActiveSection(sectionId) { this.activeSection = sectionId; this.isMobileMenuOpen = false; }, 
                nuovaGiornata() { this.showNotification('Apertura form nuova giornata'); },
                importaData() { document.getElementById('fileInput').click(); },
                esportaData() { const dataToExport = this.getSectionExportData(); if (Object.keys(dataToExport).length === 0 || (Array.isArray(Object.values(dataToExport)[0]) && Object.values(dataToExport)[0].length === 0)) { this.showNotification('Nessun dato da esportare per questa sezione.'); return; } const jsonString = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = this.getSectionFileName(); document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); },
                eliminaDatiSezione() {
                    const sectionMessages = { 'registro': 'Sei sicuro di voler eliminare tutti i carichi? Questa azione non può essere annullata.', 'prezzi': 'Sei sicuro di voler eliminare tutti i listini prezzi? Questa azione non può essere annullata.', 'amministrazione': 'Sei sicuro di voler eliminare tutti i clienti e le loro transazioni? Questa azione non può essere annullata.', 'anagrafica': 'Sei sicuro di voler eliminare tutti i contatti? Questa azione non può essere annullata.', 'virtual': 'Sei sicuro di voler eliminare tutti i turni? Questa azione non può essere annullata.' };
                    const message = sectionMessages[this.activeSection] || 'Sei sicuro di voler eliminare tutti i dati? Questa azione non può essere annullata.';
                    this.showConfirmation(message, () => {
                        switch(this.activeSection) {
                            case 'registro': this.registryEntries = []; this.summary = { previousYear: { benzina: 0, gasolio: 0, dieselPlus: 0, hvolution: 0 } }; this.showNotification('Tutti i carichi sono stati eliminati.'); break;
                            case 'prezzi': this.priceHistory = []; this.competitorPrices = null; this.recommendedPrices = null; this.adbluePrice = 0; this.showNotification('Tutti i listini prezzi sono stati eliminati.'); break;
                            case 'amministrazione': this.clients = []; this.showNotification('Tutti i clienti sono stati eliminati.'); break;
                            case 'anagrafica': this.contacts = []; this.showNotification('Tutti i contatti sono stati eliminati.'); break;
                            case 'virtual': this.turni = []; this.showNotification('Tutti i turni sono stati eliminati.'); break;
                        }
                        this.saveState();
                    });
                },

                stampaDati() {
                    this.createPrintableContent();
                    
                    this.$nextTick(() => {
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    });
                },

                createPrintableContent() {
                    const existingPrintArea = document.querySelector('.dynamic-printable-area');
                    if (existingPrintArea) {
                        existingPrintArea.remove();
                    }

                    let printContent = '';
                    const currentDate = this.formatDate(this.toLocalDateString(new Date()));

                    if (this.isContoClienteModalOpen) {
                        printContent = this.createContoClientePrintContent();
                    } else {
                        switch(this.activeSection) {
                            case 'registro':
                                printContent = this.createRegistryPrintContent(currentDate);
                                break;
                            case 'prezzi':
                                printContent = this.createPricesPrintContent(currentDate);
                                break;
                            case 'amministrazione':
                                printContent = this.createAdminPrintContent(currentDate);
                                break;
                            case 'anagrafica':
                                printContent = this.createContactsPrintContent(currentDate);
                                break;
                            case 'virtual':
                                printContent = this.createVirtualPrintContent(currentDate);
                                break;
                            case 'statistiche':
                                printContent = this.createStatsPrintContent(currentDate);
                                break;
                            default:
                                printContent = this.createHomePrintContent(currentDate);
                        }
                    }

                    const printDiv = document.createElement('div');
                    printDiv.className = 'dynamic-printable-area printable-area';
                    printDiv.innerHTML = printContent;
                    document.body.appendChild(printDiv);
                },

                createRegistryPrintContent(currentDate) {
                    const summaryData = this.summaryTotals;
                    let content = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Registro di Carico Carburante</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>

                        <h3 style="margin-bottom: 15px;">Riepilogo Totali ${this.currentYear}</h3>
                        <table style="width: 100%; margin-bottom: 30px;">
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th style="text-align: right;">Carico</th>
                                    <th style="text-align: right;">Differenza</th>
                                    <th style="text-align: right;">Anno Prec.</th>
                                    <th style="text-align: right;">Contabile</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    summaryData.items.forEach(item => {
                        content += `
                            <tr>
                                <td>${item.name}</td>
                                <td style="text-align: right;">${this.formatCarico(item.carico)}</td>
                                <td style="text-align: right;">${this.formatCaricoDifferenza(item.differenza)}</td>
                                <td style="text-align: right;">${this.formatCarico(item.previousYear)}</td>
                                <td style="text-align: right;">${this.formatCarico(item.contabile)}</td>
                            </tr>`;
                    });

                    content += `
                                <tr style="font-weight: bold; border-top: 2px solid #000;">
                                    <td>TOTALE</td>
                                    <td style="text-align: right;">${this.formatCarico(summaryData.grandTotal.carico)}</td>
                                    <td style="text-align: right;">${this.formatCaricoDifferenza(summaryData.grandTotal.differenza)}</td>
                                    <td style="text-align: right;">${this.formatCarico(summaryData.grandTotal.previousYear)}</td>
                                    <td style="text-align: right;">${this.formatCarico(summaryData.grandTotal.contabile)}</td>
                                </tr>
                            </tbody>
                        </table>

                        <h3 style="margin-bottom: 15px;">Storico Carichi</h3>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th style="text-align: right;">Benzina</th>
                                    <th style="text-align: right;">Gasolio</th>
                                    <th style="text-align: right;">Diesel+</th>
                                    <th style="text-align: right;">HVOlution</th>
                                    <th>Autista</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    this.filteredRegistryEntries.forEach(entry => {
                        content += `
                            <tr>
                                <td>${this.formatDate(entry.date)}</td>
                                <td style="text-align: right;">${this.formatCarico(entry.benzina.carico)}</td>
                                <td style="text-align: right;">${this.formatCarico(entry.gasolio.carico)}</td>
                                <td style="text-align: right;">${this.formatCarico(entry.dieselPlus.carico)}</td>
                                <td style="text-align: right;">${this.formatCarico(entry.hvolution.carico)}</td>
                                <td>${entry.autistaName}</td>
                            </tr>`;
                    });

                    content += '</tbody></table>';
                    return content;
                },

                createPricesPrintContent(currentDate) {
                    let content = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Gestione Prezzi</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>`;

                    if (this.recommendedPrices) {
                        content += `
                            <h3 style="margin-bottom: 15px;">Prezzi Applicati (${this.formatDate(this.recommendedPrices.date, '-')})</h3>
                            <table style="width: 100%; margin-bottom: 30px;">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th style="text-align: right;">Iperself</th>
                                        <th style="text-align: right;">Servito</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>Benzina</td><td style="text-align: right;">${this.formatPrice(this.getIperselfPrice('benzina'))}</td><td style="text-align: right;">${this.formatPrice(this.getServitoPrice('benzina'))}</td></tr>
                                    <tr><td>Diesel+</td><td style="text-align: right;">${this.formatPrice(this.getIperselfPrice('dieselPlus'))}</td><td style="text-align: right;">${this.formatPrice(this.getServitoPrice('dieselPlus'))}</td></tr>
                                    <tr><td>Gasolio</td><td style="text-align: right;">${this.formatPrice(this.getIperselfPrice('gasolio'))}</td><td style="text-align: right;">${this.formatPrice(this.getServitoPrice('gasolio'))}</td></tr>
                                    <tr><td>HVOlution</td><td style="text-align: right;">${this.formatPrice(this.getIperselfPrice('hvolution'))}</td><td style="text-align: right;">${this.formatPrice(this.getServitoPrice('hvolution'))}</td></tr>
                                    <tr><td>AdBlue</td><td style="text-align: right;">-</td><td style="text-align: right;">${this.formatPrice(this.adbluePrice)}</td></tr>
                                </tbody>
                            </table>`;
                    }

                    if (this.priceHistory.length > 0) {
                        content += `
                            <h3 style="margin-bottom: 15px;">Storico Listini</h3>
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Annotazioni</th>
                                        <th style="text-align: right;">Benzina</th>
                                        <th style="text-align: right;">Diesel+</th>
                                        <th style="text-align: right;">Gasolio</th>
                                        <th style="text-align: right;">HVOlution</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        this.priceHistory.forEach(price => {
                            content += `
                                <tr>
                                    <td>${this.formatDate(price.date, '-')}</td>
                                    <td>${price.annotazioni || ''}</td>
                                    <td style="text-align: right;">${this.formatPrice(price.benzina)}</td>
                                    <td style="text-align: right;">${this.formatPrice(price.dieselPlus)}</td>
                                    <td style="text-align: right;">${this.formatPrice(price.gasolio)}</td>
                                    <td style="text-align: right;">${this.formatPrice(price.hvolution)}</td>
                                </tr>`;
                        });

                        content += '</tbody></table>';
                    }

                    return content;
                },

                createAdminPrintContent(currentDate) {
                    let content = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Amministrazione Clienti</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <p><strong>Clienti Attivi:</strong> ${this.activeClients}</p>
                            <p><strong>Totale Credito:</strong> ${this.formatCurrency(this.totalCredit)}</p>
                            <p><strong>Totale Debito:</strong> ${this.formatCurrency(this.totalDebit)}</p>
                        </div>

                        <h3 style="margin-bottom: 15px;">Elenco Clienti</h3>
                        <div class="client-cards-print">`;

                    this.filteredClients.forEach(client => {
                        const lastTransaction = client.transactions.length > 0 ? this.formatDate(client.transactions[0].date) : '-';
                        content += `
                            <div class="client-card-print">
                                <p style="font-weight: bold; margin-bottom: 5px;">${client.name}</p>
                                <p style="margin-bottom: 5px;"><strong>Saldo:</strong> ${this.formatCurrency(client.balance)}</p>
                                <p style="font-size: 10px;">Ultima operazione: ${lastTransaction}</p>
                            </div>`;
                    });

                    content += '</div>';
                    return content;
                },

                createContactsPrintContent(currentDate) {
                    let content = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Anagrafica Contatti</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>

                        <p style="margin-bottom: 20px;"><strong>Totale Contatti:</strong> ${this.filteredContacts.length}</p>

                        <div class="contact-cards-print">`;

                    this.filteredContacts.forEach(contact => {
                        content += `
                            <div class="contact-card-print">
                                <p style="font-weight: bold; margin-bottom: 5px;">${contact.firstName} ${contact.lastName}</p>`;
                        
                        if (contact.organization) {
                            content += `<p style="margin-bottom: 3px;"><strong>Organizzazione:</strong> ${contact.organization}</p>`;
                        }
                        if (contact.phone) {
                            content += `<p style="margin-bottom: 3px;"><strong>Telefono:</strong> ${contact.phone}</p>`;
                        }
                        if (contact.email) {
                            content += `<p style="margin-bottom: 3px;"><strong>Email:</strong> ${contact.email}</p>`;
                        }
                        if (contact.notes) {
                            content += `<p style="margin-bottom: 3px; font-size: 10px;"><strong>Note:</strong> ${contact.notes}</p>`;
                        }

                        content += '</div>';
                    });

                    content += '</div>';
                    return content;
                },

                createVirtualPrintContent(currentDate) {
                    let content = `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">VirtualStation - Turni</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>`;

                    if (this.dailyTurnoSummary) {
                        content += `
                            <h3 style="margin-bottom: 15px;">Riepilogo Turni del ${this.dailyTurnoSummary.date}</h3>
                            <table style="width: 100%; margin-bottom: 30px;">
                                <thead>
                                    <tr>
                                        <th>Turno</th>
                                        <th style="text-align: right;">Litri Totali</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        for (const [turnoName, turnoData] of Object.entries(this.dailyTurnoSummary.turni)) {
                            content += `
                                <tr>
                                    <td>${turnoName.toUpperCase()}</td>
                                    <td style="text-align: right;">${this.formatCarico(turnoData.totalLiters)} L</td>
                                </tr>`;
                        }

                        content += '</tbody></table>';
                    }

                    if (this.turni.length > 0) {
                        content += `
                            <h3 style="margin-bottom: 15px;">Storico Completo Turni</h3>
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Turno</th>
                                        <th style="text-align: right;">Benzina</th>
                                        <th style="text-align: right;">Diesel+</th>
                                        <th style="text-align: right;">Gasolio</th>
                                        <th style="text-align: right;">HVOlution</th>
                                        <th style="text-align: right;">AdBlue</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                        this.turni.forEach(turno => {
                            content += `
                                <tr>
                                    <td>${this.formatDate(turno.date, '-')}</td>
                                    <td>${turno.turno.toUpperCase()}</td>
                                    <td style="text-align: right;">${this.formatCarico(this.getTurnoTotal(turno, 'benzina'))}</td>
                                    <td style="text-align: right;">${this.formatCarico(this.getTurnoTotal(turno, 'dieselPlus'))}</td>
                                    <td style="text-align: right;">${this.formatCarico(this.getTurnoTotal(turno, 'gasolio'))}</td>
                                    <td style="text-align: right;">${this.formatCarico(this.getTurnoTotal(turno, 'hvolution'))}</td>
                                    <td style="text-align: right;">${this.formatCarico(this.getTurnoTotal(turno, 'adblue'))}</td>
                                </tr>`;
                        });

                        content += '</tbody></table>';
                    }

                    return content;
                },

                createStatsPrintContent(currentDate) {
                    const stats = this.statsData;
                    return `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Statistiche</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                            <p style="font-size: 12px;">Periodo: ${this.statsFilter.charAt(0).toUpperCase() + this.statsFilter.slice(1)}</p>
                        </div>

                        <div style="margin-bottom: 30px;">
                            <h3 style="margin-bottom: 15px;">Riepilogo</h3>
                            <p><strong>Litri venduti:</strong> ${this.formatCarico(stats.litriTotali)} L</p>
                            <p><strong>Prodotto più venduto:</strong> ${stats.prodottoPiuVenduto.nome} (${this.formatCarico(stats.prodottoPiuVenduto.litri)} L)</p>
                            <p><strong>Percentuale Servito:</strong> ${stats.percentualeServito.toFixed(1)}%</p>
                            <p><strong>Fatturato Stimato:</strong> ${this.formatCurrency(stats.fatturato)}</p>
                        </div>

                        <h3 style="margin-bottom: 15px;">Breakdown per Prodotto</h3>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th style="text-align: right;">Litri</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Benzina</td><td style="text-align: right;">${this.formatCarico(stats.breakdownProdotti.benzina)}</td></tr>
                                <tr><td>Gasolio</td><td style="text-align: right;">${this.formatCarico(stats.breakdownProdotti.gasolio)}</td></tr>
                                <tr><td>Diesel+</td><td style="text-align: right;">${this.formatCarico(stats.breakdownProdotti.dieselPlus)}</td></tr>
                                <tr><td>HVOlution</td><td style="text-align: right;">${this.formatCarico(stats.breakdownProdotti.hvolution)}</td></tr>
                                <tr><td>AdBlue</td><td style="text-align: right;">${this.formatCarico(stats.breakdownProdotti.adblue)}</td></tr>
                            </tbody>
                        </table>`;
                },

                createHomePrintContent(currentDate) {
                    return `
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="font-size: 24px; margin-bottom: 10px;">${this.title}</h1>
                            <h2 style="font-size: 18px; margin-bottom: 5px;">Dashboard</h2>
                            <p style="font-size: 12px;">Data di stampa: ${currentDate}</p>
                        </div>

                        <p style="text-align: center; font-size: 16px;">Benvenuto nella dashboard di gestione della stazione di servizio.</p>

                        <div style="margin-top: 40px;">
                            <h3>Riepilogo Generale</h3>
                            <p><strong>Anno:</strong> ${this.currentYear}</p>
                            <p><strong>Clienti Attivi:</strong> ${this.activeClients}</p>
                            <p><strong>Carichi Registrati:</strong> ${this.registryEntries.length}</p>
                            <p><strong>Turni Registrati:</strong> ${this.turni.length}</p>
                            <p><strong>Contatti in Rubrica:</strong> ${this.contacts.length}</p>
                        </div>`;
                },

                createContoClientePrintContent() {
                    if (!this.contoCliente) return '';

                    let transactionsHtml = '';
                    [...this.sortedTransactions].reverse().forEach(tx => {
                        transactionsHtml += `
                            <tr class="border-b">
                                <td class="p-2">${this.formatDate(tx.date)}</td>
                                <td class="p-2">${tx.description}</td>
                                <td class="p-2 text-right">${tx.description === 'Acconto' ? '+' : '-'}${this.formatCurrency(tx.amount)}</td>
                            </tr>`;
                    });

                    return `
                        <div style="padding: 2rem;">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h1 style="font-size: 1.875rem; font-weight: bold;">${this.title}</h1>
                                <p>Stazione di Servizio</p>
                            </div>
                            <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #000;">
                                <h2 style="font-size: 1.25rem; font-weight: 600;">Estratto Conto: ${this.contoCliente.name}</h2>
                                <p style="font-size: 0.875rem;">Data di stampa: ${this.formatDate(this.toLocalDateString(new Date()))}</p>
                            </div>
                            <div style="margin-bottom: 2rem; text-align: right;">
                                 <span style="font-size: 1.125rem;">SALDO FINALE:</span>
                                 <span style="font-size: 1.5rem; font-weight: bold; margin-left: 1rem;">${this.formatCurrency(this.contoCliente.balance)}</span>
                            </div>
                            <table style="width: 100%; text-align: left; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000;">
                                        <th style="padding: 0.5rem;">Data</th>
                                        <th style="padding: 0.5rem;">Descrizione</th>
                                        <th style="padding: 0.5rem; text-align: right;">Importo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactionsHtml}
                                </tbody>
                            </table>
                        </div>`;
                },
            } 
        }
        document.addEventListener('alpine:init', () => { lucide.createIcons(); });
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 h-full" x-data="dashboardApp()">
    
    <input type="file" id="fileInput" @change="handleFileUpload($event)" accept=".json" class="hidden">

    <aside class="fixed top-0 left-0 z-40 h-screen transition-all duration-300 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 md:translate-x-0 no-print"
           :class="{ 
               'w-64': !isSidebarCollapsed, 
               'w-20': isSidebarCollapsed,
               'translate-x-0': isMobileMenuOpen, 
               '-translate-x-full': !isMobileMenuOpen 
           }">
        <div class="flex items-center justify-center h-16 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center">
                <i data-lucide="box" class="w-10 h-10 text-blue-600" :class="{ 'mr-3': !isSidebarCollapsed }"></i>
                <span class="text-3xl font-bold whitespace-nowrap text-blue-600" x-show="!isSidebarCollapsed" x-text="title"></span>
            </div>
        </div>
        
        <div class="overflow-y-auto py-5 px-3 h-[calc(100vh-4rem)] bg-white dark:bg-gray-800">
            <ul class="space-y-2">
                <template x-for="item in menuItems" :key="item.id">
                    <li>
                        <a href="javascript:void(0)" @click.prevent="setActiveSection(item.id)"
                           class="flex items-center p-2 text-base font-normal rounded-lg transition duration-75 hover:bg-gray-100 dark:hover:bg-gray-700 group"
                           :class="{
                               'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300': activeSection === item.id,
                               'text-gray-900 dark:text-gray-200': activeSection !== item.id,
                               'justify-center': isSidebarCollapsed
                           }">
                            <i :data-lucide="item.icon" 
                               class="w-6 h-6 transition duration-75" 
                               :class="{ 'text-blue-700 dark:text-blue-300': activeSection === item.id, 'text-gray-400 dark:text-gray-500 group-hover:text-gray-900 dark:group-hover:text-white': activeSection !== item.id }"></i>
                            <span class="ml-3" x-show="!isSidebarCollapsed" x-text="item.label"></span>
                        </a>
                    </li>
                </template>
            </ul>
        </div>
    </aside>

    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-2.5 fixed top-0 right-0 z-30 left-0 transition-all duration-300 no-print"
         :class="{ 'md:ml-64': !isSidebarCollapsed, 'md:ml-20': isSidebarCollapsed }">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center space-x-4">
                <button @click="isMobileMenuOpen = !isMobileMenuOpen" 
                        class="p-2 mr-2 text-gray-600 dark:text-gray-400 rounded-lg cursor-pointer md:hidden hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 focus:bg-gray-100 dark:focus:bg-gray-700 focus:ring-2 focus:ring-gray-100 dark:focus:ring-gray-700">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                
                <div class="relative" x-show="['home', 'registro', 'amministrazione', 'anagrafica'].includes(activeSection)">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </div>
                    <input type="search"
                           x-model.debounce.300ms="currentSearchQuery"
                           :placeholder="searchPlaceholder"
                           class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-64 pl-10 p-2.5">
                </div>

                 <div x-show="activeSection === 'amministrazione'" class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                        <i data-lucide="filter" class="w-5 h-5 mr-2"></i> Filtri <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                    </button>
                    <div x-show="open" @click.outside="open = false" class="absolute left-0 mt-2 w-56 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-50">
                        <a href="javascript:void(0)" @click.prevent="adminFilter = 'all'; open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="users-round" class="w-4 h-4 mr-3"></i> Tutti i Clienti
                        </a>
                        <a href="javascript:void(0)" @click.prevent="adminFilter = 'credit'; open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="user-round-plus" class="w-4 h-4 mr-3"></i> Clienti a credito
                        </a>
                         <a href="javascript:void(0)" @click.prevent="adminFilter = 'debit'; open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="user-round-minus" class="w-4 h-4 mr-3"></i> Clienti a debito
                        </a>
                        <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                        <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <div class="flex items-center text-gray-700 dark:text-gray-200">
                                <i :data-lucide="showAdminContent ? 'eye' : 'eye-off'" class="w-4 h-4 mr-3"></i>
                                <span class="text-sm" x-text="showAdminContent ? 'Mostra' : 'Nascondi'"></span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" x-model="showAdminContent" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                 <div x-show="activeSection === 'anagrafica'" class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                        <i data-lucide="filter" class="w-5 h-5 mr-2"></i> Filtri <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                    </button>
                    <div x-show="open" @click.outside="open = false" class="absolute left-0 mt-2 w-56 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-50">
                        <a href="javascript:void(0)" @click.prevent="contactFilter = 'all'; open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="users-round" class="w-4 h-4 mr-3"></i> Tutti i contatti
                        </a>
                        <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                        <div class="px-4 py-2 text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide font-semibold">Etichette</div>
                        <template x-for="label in contactLabels" :key="label.id">
                            <a href="javascript:void(0)" @click.prevent="contactFilter = label.id; open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                <span class="w-3 h-3 rounded-full mr-3" :style="'background-color: ' + label.color"></span> <span x-text="label.name"></span>
                            </a>
                        </template>
                         <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                         <a href="javascript:void(0)" @click.prevent="openGestisciEtichetteModal(); open = false" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="settings" class="w-4 h-4 mr-3"></i> Gestisci etichette
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <button @click="nuovaGiornata()" x-show="activeSection === 'home'"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Nuova giornata
                </button>
                <button @click="openNuovoCaricoModal()" x-show="activeSection === 'registro'"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Nuovo carico
                </button>
                <button @click="openNuovoListinoModal()" x-show="activeSection === 'prezzi'"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="clipboard-plus" class="w-5 h-5 mr-2"></i>
                    Nuovo Listino
                </button>
                 <button @click="openConcorrenzaModal()" x-show="activeSection === 'prezzi'"
                        class="text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                    Concorrenza
                </button>
                <button @click="openNewClientModal()" x-show="activeSection === 'amministrazione'" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                    Nuovo Cliente
                </button>
                <button @click="openNewContactModal()" x-show="activeSection === 'anagrafica'" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                    Nuovo Contatto
                </button>
                <button @click="openNuovoTurnoModal()" x-show="activeSection === 'virtual'"
                        class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    Nuovo Turno
                </button>

                <div class="relative" x-data="{ dropdownOpen: false }">
                    <button @click="dropdownOpen = !dropdownOpen" 
                            class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10">
                        <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                        Opzioni
                        <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                    </button>
                    
                    <div x-show="dropdownOpen" @click.outside="dropdownOpen = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-50">
                        
                        <div class="px-4 py-2 text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide font-semibold border-b dark:border-gray-600">
                            File
                        </div>
                        <button @click="importaData(); dropdownOpen = false"
                                class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="upload" class="w-4 h-4 mr-3"></i>
                            <span x-text="activeSection === 'registro' ? 'Importa registro' : 
                                          activeSection === 'prezzi' ? 'Importa prezzi' :
                                          activeSection === 'amministrazione' ? 'Importa Clienti' :
                                          activeSection === 'anagrafica' ? 'Importa contatti' :
                                          activeSection === 'virtual' ? 'Importa turni' : 'Importa dati'"></span>
                        </button>
                        <button @click="esportaData(); dropdownOpen = false"
                                class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="download" class="w-4 h-4 mr-3"></i>
                            <span x-text="activeSection === 'registro' ? 'Esporta registro' : 
                                          activeSection === 'prezzi' ? 'Esporta prezzi' :
                                          activeSection === 'amministrazione' ? 'Esporta clienti' :
                                          activeSection === 'anagrafica' ? 'Esporta contatti' :
                                          activeSection === 'virtual' ? 'Esporta turni' : 'Esporta dati'"></span>
                        </button>
                        <button @click="stampaDati(); dropdownOpen = false"
                                class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <i data-lucide="printer" class="w-4 h-4 mr-3"></i>
                            Stampa
                        </button>
                        
                        <div class="border-t border-gray-200 dark:border-gray-600 my-1"></div>
                        
                        <button @click="eliminaDatiSezione(); dropdownOpen = false"
                                class="flex items-center w-full px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-3"></i>
                            <span x-text="activeSection === 'registro' ? 'Elimina tutti i carichi' : 
                                          activeSection === 'prezzi' ? 'Elimina tutti i prezzi' :
                                          activeSection === 'amministrazione' ? 'Elimina tutti i clienti' :
                                          activeSection === 'anagrafica' ? 'Elimina tutti i contatti' :
                                          activeSection === 'virtual' ? 'Elimina tutti i turni' : 'Elimina tutti i dati'"></span>
                        </button>
                        
                        <div class="px-4 py-2 text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wide font-semibold border-t dark:border-gray-600">
                            Impostazioni
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <div class="flex items-center text-gray-700 dark:text-gray-200">
                                <i :data-lucide="isDarkMode ? 'moon' : 'sun'" class="w-4 h-4 mr-3"></i>
                                <span class="text-sm" x-text="isDarkMode ? 'Tema scuro' : 'Tema chiaro'"></span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" x-model="isDarkMode" @change="updateTheme()" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <div class="flex items-center text-gray-700 dark:text-gray-200">
                                <i :data-lucide="isSidebarCollapsed ? 'panel-left-open' : 'panel-left-close'" class="w-4 h-4 mr-3"></i>
                                <span class="text-sm">Menu laterale</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" x-model="isSidebarCollapsed" @change="saveState()" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <div class="flex items-center justify-between px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600">
                            <div class="flex items-center text-gray-700 dark:text-gray-200">
                                <i :data-lucide="isFullscreen ? 'minimize' : 'maximize'" class="w-4 h-4 mr-3"></i>
                                <span class="text-sm">Schermo intero</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" :checked="isFullscreen" @change="toggleFullscreen()" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="p-4 h-auto pt-20 bg-gray-50 dark:bg-gray-900 transition-all duration-300"
          :class="{ 'md:ml-64': !isSidebarCollapsed, 'md:ml-20': isSidebarCollapsed }"
          :data-section="activeSection">
        
        <div x-show="activeSection === 'home'" class="mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Dashboard MyStation</h1>
                <p class="text-gray-600 dark:text-gray-400">Benvenuto nella dashboard di gestione della stazione di servizio.</p>
            </div>
        </div>

        <div x-show="activeSection === 'anagrafica'" class="mb-4 space-y-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <template x-for="contact in filteredContacts" :key="contact.id">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col justify-between">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700">
                                    <span class="text-lg font-medium text-gray-700 dark:text-gray-300" x-text="(contact.firstName ? contact.firstName.charAt(0) : '') + (contact.lastName ? contact.lastName.charAt(0) : '')"></span>
                                </span>
                            </div>
                            <div class="ml-4 flex-1">
                                <p class="font-bold text-gray-900 dark:text-white" x-text="contact.firstName + ' ' + contact.lastName"></p>
                                <p x-show="contact.organization" class="text-sm text-gray-600 dark:text-gray-400" x-text="contact.organization"></p>
                            </div>
                        </div>
                         <div class="flex items-center justify-between mt-4 border-t dark:border-gray-700 pt-4">
                             <div class="flex flex-wrap gap-1">
                                <template x-for="labelId in contact.labels" :key="labelId">
                                    <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full" :style="'background-color: ' + getLabelColor(labelId) + '; color: white;'">
                                        <span x-text="contactLabels.find(l => l.id === labelId)?.name"></span>
                                    </span>
                                </template>
                            </div>
                            <div class="flex space-x-2">
                                <button @click="editContact(contact)" class="p-1 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i data-lucide="square-pen" style="width: 18px; height: 18px;"></i>
                                </button>
                                <button @click="deleteContact(contact)" class="p-1 text-gray-500 hover:text-red-600 dark:hover:text-red-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                </button>
                            </div>
                         </div>
                    </div>
                </template>
            </div>
            <div x-show="filteredContacts.length === 0" class="text-center py-12">
                 <div class="text-gray-500 dark:text-gray-400">
                    <i data-lucide="user-x" class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                    <p class="text-lg">Nessun contatto trovato</p>
                    <p class="text-sm">Aggiungi un nuovo contatto o modifica i filtri di ricerca.</p>
                </div>
            </div>
        </div>

        <div x-show="activeSection === 'amministrazione'" class="mb-4 space-y-8">
            <div x-show="showAdminContent" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full mr-6">
                            <i data-lucide="users" class="w-8 h-8 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Clienti Attivi</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="activeClients"></p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-green-100 dark:bg-green-900 p-4 rounded-full mr-6">
                            <i data-lucide="trending-up" class="w-8 h-8 text-green-600 dark:text-green-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Totale Credito</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatCurrency(totalCredit)"></p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-red-100 dark:bg-red-900 p-4 rounded-full mr-6">
                            <i data-lucide="trending-down" class="w-8 h-8 text-red-600 dark:text-red-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Totale Debito</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatCurrency(totalDebit)"></p>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 client-card-container">
                    <template x-for="client in filteredClients" :key="client.id">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col justify-between client-card">
                            <div class="flex items-start">
                                <i data-lucide="handshake" class="w-8 h-8 text-gray-400 mr-4 no-print"></i>
                                <div>
                                    <p class="font-bold text-gray-900 dark:text-white" x-text="client.name"></p>
                                    <p class="text-lg font-semibold" :class="getClientBalanceClass(client.balance)" x-text="formatCurrency(client.balance)"></p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-4 border-t dark:border-gray-700 pt-4 no-print">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Ultima operazione: <span x-text="client.transactions.length > 0 ? formatDate(client.transactions[0].date) : '-' "></span></p>
                                <div class="flex space-x-2">
                                    <button @click="editClient(client)" class="p-1 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <i data-lucide="square-pen" style="width: 18px; height: 18px;"></i>
                                    </button>
                                    <button @click="openContoClienteModal(client)" class="p-1 text-gray-500 hover:text-blue-600 dark:hover:text-blue-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                        <i data-lucide="circle-arrow-out-up-right" style="width: 18px; height: 18px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                 <div x-show="filteredClients.length === 0" class="text-center py-12">
                     <div class="text-gray-500 dark:text-gray-400">
                        <i data-lucide="user-x" class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                        <p class="text-lg">Nessun cliente trovato</p>
                        <p class="text-sm">Aggiungi un nuovo cliente o modifica i filtri di ricerca.</p>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeSection === 'registro'" class="mb-4 space-y-8">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-1/2">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow h-full overflow-hidden">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Riepilogo totali <span x-text="currentYear"></span></h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Prodotto</th>
                                        <th scope="col" class="px-6 py-3 text-right">Carico</th>
                                        <th scope="col" class="px-6 py-3 text-right">Differenza</th>
                                        <th scope="col" class="px-6 py-3 text-right">Anno Prec.</th>
                                        <th scope="col" class="px-6 py-3 text-right">Contabile</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="item in summaryTotals.items" :key="item.name">
                                        <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap" x-text="item.name"></th>
                                            <td class="px-6 py-4 text-right" x-text="formatCarico(item.carico)"></td>
                                            <td class="px-6 py-4 text-right" :class="getCaricoDifferenceClass(item.differenza)" x-text="formatCaricoDifferenza(item.differenza)"></td>
                                            <td class="px-6 py-4 text-right">
                                                <input type="number" x-model.number="summary.previousYear[item.key]" @change="saveState()"
                                                       class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 text-right">
                                            </td>
                                            <td class="px-6 py-4 text-right font-semibold" x-text="formatCarico(item.contabile)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                                <tfoot class="text-xs text-gray-900 dark:text-white uppercase bg-gray-100 dark:bg-gray-700 font-bold">
                                    <tr>
                                        <td class="px-6 py-3">Totale</td>
                                        <td class="px-6 py-3 text-right" x-text="formatCarico(summaryTotals.grandTotal.carico)"></td>
                                        <td class="px-6 py-3 text-right" :class="getCaricoDifferenceClass(summaryTotals.grandTotal.differenza)" x-text="formatCaricoDifferenza(summaryTotals.grandTotal.differenza)"></td>
                                        <td class="px-6 py-3 text-right" x-text="formatCarico(summaryTotals.grandTotal.previousYear)"></td>
                                        <td class="px-6 py-3 text-right" x-text="formatCarico(summaryTotals.grandTotal.contabile)"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-1/2 flex flex-col gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full mr-6">
                            <i data-lucide="fuel" class="w-8 h-8 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Riepilogo litri caricati</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="formatCarico(summaryTotals.grandTotal.carico) + ' L'"></p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-green-100 dark:bg-green-900 p-4 rounded-full mr-6">
                            <i data-lucide="award" class="w-8 h-8 text-green-600 dark:text-green-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Prodotto più caricato</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="topProduct.name"></p>
                            <p class="text-md text-gray-600 dark:text-gray-300" x-text="formatCarico(topProduct.amount) + ' L'"></p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                        <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-full mr-6">
                            <i data-lucide="user-check" class="w-8 h-8 text-purple-600 dark:text-purple-300"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Autista top</p>
                            <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="topDriver.name"></p>
                            <p class="text-md text-gray-600 dark:text-gray-300" x-text="topDriver.deliveries + ' carichi'"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Storico carichi carburante <span x-text="currentYear"></span></h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3">Data</th>
                                <th scope="col" class="px-6 py-3">Benzina</th>
                                <th scope="col" class="px-6 py-3">Gasolio</th>
                                <th scope="col" class="px-6 py-3">Diesel+</th>
                                <th scope="col" class="px-6 py-3">HVOlution</th>
                                <th scope="col" class="px-6 py-3">Autista</th>
                                <th scope="col" class="px-6 py-3 text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="entry in filteredRegistryEntries" :key="entry.id">
                                <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white" x-text="formatDate(entry.date)"></td>
                                    <td class="px-6 py-4" x-text="formatCarico(entry.benzina.carico)"></td>
                                    <td class="px-6 py-4" x-text="formatCarico(entry.gasolio.carico)"></td>
                                    <td class="px-6 py-4" x-text="formatCarico(entry.dieselPlus.carico)"></td>
                                    <td class="px-6 py-4" x-text="formatCarico(entry.hvolution.carico)"></td>
                                    <td class="px-6 py-4" x-text="entry.autistaName"></td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-center space-x-2">
                                            <button @click="editEntry(entry)" class="p-1 text-blue-600 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="square-pen" style="width: 18px; height: 18px;"></i>
                                            </button>
                                            <button @click="deleteEntry(entry)" class="p-1 text-red-600 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="filteredRegistryEntries.length === 0" class="p-8 text-center">
                        <div class="text-gray-500 dark:text-gray-400">
                            <i data-lucide="database" class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                            <p class="text-lg">Nessun dato da visualizzare</p>
                            <p class="text-sm">Aggiungi un nuovo carico per iniziare.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeSection === 'prezzi'" class="mb-4 space-y-8">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-1/2">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white">Prezzi applicati <span class="text-sm font-normal" x-text="recommendedPrices ? '('+formatDate(recommendedPrices.date, '-')+')' : ''"></span></h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Prodotto</th>
                                        <th scope="col" class="px-6 py-3 text-right">Iperself</th>
                                        <th scope="col" class="px-6 py-3 text-right">Servito</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Benzina</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getIperselfPrice('benzina'))"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getServitoPrice('benzina'))"></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Diesel+</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getIperselfPrice('dieselPlus'))"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getServitoPrice('dieselPlus'))"></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Gasolio</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getIperselfPrice('gasolio'))"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getServitoPrice('gasolio'))"></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">HVOlution</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getIperselfPrice('hvolution'))"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(getServitoPrice('hvolution'))"></td>
                                    </tr>
                                     <tr class="bg-white dark:bg-gray-800">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">AdBlue</th>
                                        <td class="px-6 py-4 text-right">-</td>
                                        <td class="px-6 py-4 text-right">
                                            <input type="number" step="0.001" x-model.number="adbluePrice" @change="saveState()" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-24 ml-auto p-2 text-right">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-1/2 space-y-8">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                             <h2 class="text-xl font-bold text-gray-900 dark:text-white">Prezzi concorrenza <span class="text-sm font-normal" x-text="competitorPrices ? '('+formatDate(competitorPrices.date, '-')+')' : ''"></span></h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Prodotto</th>
                                        <th scope="col" class="px-6 py-3 text-right">MyOil</th>
                                        <th scope="col" class="px-6 py-3 text-right">Esso</th>
                                        <th scope="col" class="px-6 py-3 text-right">Q8</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Benzina</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.myoil.benzina)"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.esso.benzina)"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.q8.benzina)"></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Gasolio</th>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.myoil.gasolio)"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.esso.gasolio)"></td>
                                        <td class="px-6 py-4 text-right" x-text="formatPrice(competitorPrices?.q8.gasolio)"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                             <h2 class="text-xl font-bold text-gray-900 dark:text-white">Differenza Prezzi (vs Iperself)</h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Prodotto</th>
                                        <th scope="col" class="px-6 py-3 text-right">MyOil</th>
                                        <th scope="col" class="px-6 py-3 text-right">Esso</th>
                                        <th scope="col" class="px-6 py-3 text-right">Q8</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Benzina</th>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.myoil.benzina)" x-text="formatDifference(priceDifferences?.myoil.benzina)"></td>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.esso.benzina)" x-text="formatDifference(priceDifferences?.esso.benzina)"></td>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.q8.benzina)" x-text="formatDifference(priceDifferences?.q8.benzina)"></td>
                                    </tr>
                                    <tr class="bg-white dark:bg-gray-800">
                                        <th class="px-6 py-4 font-medium text-gray-900 dark:text-white">Gasolio</th>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.myoil.gasolio)" x-text="formatDifference(priceDifferences?.myoil.gasolio)"></td>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.esso.gasolio)" x-text="formatDifference(priceDifferences?.esso.gasolio)"></td>
                                        <td class="px-6 py-4 text-right" :class="getDifferenceClass(priceDifferences?.q8.gasolio)" x-text="formatDifference(priceDifferences?.q8.gasolio)"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Storico Listini</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3">Data</th>
                                <th scope="col" class="px-6 py-3">Annotazioni</th>
                                <th scope="col" class="px-6 py-3 text-right">Benzina</th>
                                <th scope="col" class="px-6 py-3 text-right">Diesel+</th>
                                <th scope="col" class="px-6 py-3 text-right">Gasolio</th>
                                <th scope="col" class="px-6 py-3 text-right">HVOlution</th>
                                <th scope="col" class="px-6 py-3 text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                             <template x-for="price in priceHistory" :key="price.id">
                                <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white" x-text="formatDate(price.date, '-')"></td>
                                    <td class="px-6 py-4 text-gray-600 dark:text-gray-400" x-text="price.annotazioni"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatPrice(price.benzina)"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatPrice(price.dieselPlus)"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatPrice(price.gasolio)"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatPrice(price.hvolution)"></td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-center space-x-2">
                                            <button @click="editPrice(price)" class="p-1 text-blue-600 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="square-pen" style="width: 18px; height: 18px;"></i>
                                            </button>
                                            <button @click="deletePrice(price)" class="p-1 text-red-600 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                     <div x-show="priceHistory.length === 0" class="p-8 text-center">
                        <div class="text-gray-500 dark:text-gray-400">
                            <i data-lucide="clipboard-x" class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                            <p class="text-lg">Nessun listino presente</p>
                            <p class="text-sm">Aggiungi un nuovo listino per iniziare.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeSection === 'virtual'" class="mb-4 space-y-6">
            <template x-if="dailyTurnoSummary">
                 <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4" x-text="'Riepilogo Turni del ' + dailyTurnoSummary.date"></h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <template x-for="(turnoData, turnoName) in dailyTurnoSummary.turni" :key="turnoName">
                            <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-500 dark:text-gray-400">Turno</p>
                                <p class="text-2xl font-bold text-gray-900 dark:text-white uppercase" x-text="turnoName"></p>
                                <p class="text-lg text-blue-600 dark:text-blue-400" x-text="formatCarico(turnoData.totalLiters) + ' L'"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

             <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Storico Completo Turni</h2>
                </div>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 dark:text-gray-400 uppercase bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3">Data</th>
                                <th scope="col" class="px-6 py-3">Turno</th>
                                <th scope="col" class="px-6 py-3 text-right">Benzina</th>
                                <th scope="col" class="px-6 py-3 text-right">Diesel+</th>
                                <th scope="col" class="px-6 py-3 text-right">Gasolio</th>
                                <th scope="col" class="px-6 py-3 text-right">HVOlution</th>
                                <th scope="col" class="px-6 py-3 text-right">AdBlue</th>
                                <th scope="col" class="px-6 py-3 text-center">Azioni</th>
                            </tr>
                        </thead>
                         <tbody>
                            <template x-for="turno in turni" :key="turno.id">
                                <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white" x-text="formatDate(turno.date, '-')"></td>
                                    <td class="px-6 py-4 uppercase" x-text="turno.turno"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatCarico(getTurnoTotal(turno, 'benzina'))"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatCarico(getTurnoTotal(turno, 'dieselPlus'))"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatCarico(getTurnoTotal(turno, 'gasolio'))"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatCarico(getTurnoTotal(turno, 'hvolution'))"></td>
                                    <td class="px-6 py-4 text-right" x-text="formatCarico(getTurnoTotal(turno, 'adblue'))"></td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center justify-center space-x-2">
                                            <button @click="editTurno(turno)" class="p-1 text-blue-600 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="square-pen" style="width: 18px; height: 18px;"></i>
                                            </button>
                                            <button @click="deleteTurno(turno)" class="p-1 text-red-600 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full">
                                                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                     <div x-show="turni.length === 0" class="p-8 text-center">
                        <div class="text-gray-500 dark:text-gray-400">
                            <i data-lucide="clock" class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600"></i>
                            <p class="text-lg">Nessun turno inserito</p>
                            <p class="text-sm">Aggiungi un nuovo turno per iniziare.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="activeSection === 'statistiche'" class="mb-4 space-y-6" x-cloak>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10 w-36 justify-between">
                            <i data-lucide="calendar-days" class="w-5 h-5 mr-2"></i>
                            <span x-text="statsFilter.charAt(0).toUpperCase() + statsFilter.slice(1)"></span>
                            <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                        </button>
                        <div x-show="open" @click.outside="open = false" class="absolute left-0 mt-2 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-50">
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'giorno'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Giorno</a>
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'settimana'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Settimana</a>
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'mese'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Mese</a>
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'trimestre'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Trimestre</a>
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'semestre'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Semestre</a>
                            <a href="javascript:void(0)" @click.prevent="statsFilter = 'anno'; open = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">Anno</a>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <input x-show="statsFilter === 'giorno'" type="text" x-model="statsDate" placeholder="AAAA-MM-GG" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2 h-10">

                        <div x-show="statsFilter === 'mese'" class="relative">
                             <button @click="isStatsMonthDropdownOpen = !isStatsMonthDropdownOpen" class="text-gray-900 dark:text-white bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 font-medium rounded-lg text-sm px-4 py-2.5 flex items-center h-10 w-36 justify-between">
                                <span x-text="MONTH_NAMES[statsMonth]"></span>
                                <i data-lucide="chevron-down" class="w-4 h-4 ml-2"></i>
                            </button>
                             <div x-show="isStatsMonthDropdownOpen" @click.outside="isStatsMonthDropdownOpen = false" class="absolute left-0 mt-2 w-48 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg z-50">
                                <template x-for="(month, index) in MONTH_NAMES" :key="index">
                                     <a href="javascript:void(0)" @click.prevent="statsMonth = index; isStatsMonthDropdownOpen = false" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" x-text="month"></a>
                                </template>
                            </div>
                        </div>

                        <div x-show="statsFilter === 'trimestre'" class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 p-2 h-10 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.trimestre" value="1" class="mr-1"> T1</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.trimestre" value="2" class="mr-1"> T2</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.trimestre" value="3" class="mr-1"> T3</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.trimestre" value="4" class="mr-1"> T4</label>
                        </div>
                        <div x-show="statsFilter === 'semestre'" class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 p-2 h-10 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.semestre" value="1" class="mr-1"> S1</label>
                            <label class="flex items-center cursor-pointer"><input type="radio" x-model.number="statsPeriod.semestre" value="2" class="mr-1"> S2</label>
                        </div>
                        
                        <input x-show="['mese', 'trimestre', 'semestre', 'anno'].includes(statsFilter)" type="number" x-model.number="statsYear" class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-24 p-2 h-10">
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                    <div class="bg-blue-100 dark:bg-blue-900 p-4 rounded-full mr-6"> <i data-lucide="fuel" class="w-8 h-8 text-blue-600 dark:text-blue-300"></i> </div>
                    <div> <p class="text-sm text-gray-500 dark:text-gray-400">Litri venduti</p> <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="formatCarico(statsData.litriTotali) + ' L'"></p> </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                    <div class="bg-green-100 dark:bg-green-900 p-4 rounded-full mr-6"> <i data-lucide="award" class="w-8 h-8 text-green-600 dark:text-green-300"></i> </div>
                    <div> <p class="text-sm text-gray-500 dark:text-gray-400">Prodotto più venduto</p> <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="statsData.prodottoPiuVenduto.nome"></p> </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                    <div class="bg-purple-100 dark:bg-purple-900 p-4 rounded-full mr-6"> <i data-lucide="pie-chart" class="w-8 h-8 text-purple-600 dark:text-purple-300"></i> </div>
                    <div> <p class="text-sm text-gray-500 dark:text-gray-400">Percentuale Servito</p> <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="statsData.percentualeServito.toFixed(1) + '%'"></p> </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 flex items-center">
                    <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-full mr-6"> <i data-lucide="euro" class="w-8 h-8 text-yellow-600 dark:text-yellow-300"></i> </div>
                    <div> <p class="text-sm text-gray-500 dark:text-gray-400">Fatturato Stimato</p> <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="formatCurrency(statsData.fatturato)"></p> </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Totale litri per prodotto</h3>
                    <div class="h-80"><canvas id="litriChart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Rapporto Iperself / Servito</h3>
                    <div class="h-80"><canvas id="rapportoChart"></canvas></div>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Andamento vendite</h3>
                <div class="h-80"><canvas id="andamentoChart"></canvas></div>
            </div>
        </div>

    </main>
    
    <div x-show="isNuovoCaricoModalOpen" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isNuovoCaricoModalOpen" @click="closeNuovoCaricoModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div x-show="isNuovoCaricoModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="truck" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title" x-text="editingEntry ? 'Modifica Carico' : 'Nuovo Carico'"></h3>
                            <div class="mt-4 space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="carico-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                                        <input type="text" x-model="newEntry.date" id="carico-date" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label for="carico-autista" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome Autista</label>
                                        <input type="text" x-model="newEntry.autistaName" id="carico-autista" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <template x-for="product in ['benzina', 'gasolio', 'dieselPlus', 'hvolution']" :key="product">
                                        <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                                            <label class="block text-md font-semibold text-gray-800 dark:text-gray-200" x-text="product.charAt(0).toUpperCase() + product.slice(1).replace('Plus', '+')"></label>
                                            <div class="mt-2">
                                                <label class="block text-xs text-gray-600 dark:text-gray-400">Carico</label>
                                                <div class="flex items-stretch mt-1">
                                                    <button @click="newEntry[product].carico = Math.max(0, (newEntry[product].carico || 0) - 1000)" class="px-3 border border-gray-300 dark:border-gray-600 rounded-l-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">-</button>
                                                    <input type="number" step="1000" x-model.number="newEntry[product].carico" class="w-full text-center shadow-sm sm:text-sm border-y border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200">
                                                    <button @click="newEntry[product].carico = (newEntry[product].carico || 0) + 1000" class="px-3 border border-gray-300 dark:border-gray-600 rounded-r-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">+</button>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <label class="block text-xs text-gray-600 dark:text-gray-400">Differenza</label>
                                                <div class="flex items-stretch mt-1">
                                                    <button @click="newEntry[product].differenza = (newEntry[product].differenza || 0) - 1" class="px-3 border border-gray-300 dark:border-gray-600 rounded-l-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">-</button>
                                                    <input type="number" step="1" x-model.number="newEntry[product].differenza" class="w-full text-center shadow-sm sm:text-sm border-y border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200">
                                                    <button @click="newEntry[product].differenza = (newEntry[product].differenza || 0) + 1" class="px-3 border border-gray-300 dark:border-gray-600 rounded-r-md text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveNewEntry()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button type="button" @click="closeNuovoCaricoModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isNuovoListinoModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isNuovoListinoModalOpen" @click="closeNuovoListinoModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isNuovoListinoModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="clipboard-plus" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" x-text="editingPrice ? 'Modifica Listino' : 'Nuovo Listino Prezzi'"></h3>
                            <div class="mt-4 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                                        <input type="text" x-model="newPriceList.date" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Annotazioni</label>
                                        <input type="text" x-model="newPriceList.annotazioni" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Benzina</label>
                                        <input type="number" step="0.001" x-model.number="newPriceList.benzina" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Diesel+</label>
                                        <input type="number" step="0.001" x-model.number="newPriceList.dieselPlus" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Gasolio</label>
                                        <input type="number" step="0.001" x-model.number="newPriceList.gasolio" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">HVOlution</label>
                                        <input type="number" step="0.001" x-model.number="newPriceList.hvolution" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveNewPriceList()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button type="button" @click="closeNuovoListinoModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isConcorrenzaModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isConcorrenzaModalOpen" @click="closeConcorrenzaModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isConcorrenzaModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                         <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="users" class="h-6 w-6 text-red-600 dark:text-red-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Inserisci Prezzi Concorrenza</h3>
                            <div class="mt-4 space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <template x-for="competitor in ['myoil', 'esso', 'q8']" :key="competitor">
                                        <div class="space-y-2 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                            <h4 class="font-semibold text-gray-800 dark:text-gray-200" x-text="competitor.charAt(0).toUpperCase() + competitor.slice(1)"></h4>
                                            <div>
                                                <label class="block text-sm text-gray-600 dark:text-gray-400">Benzina</label>
                                                <input type="number" step="0.001" x-model.number="newCompetitorPrices[competitor].benzina" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                            </div>
                                             <div>
                                                <label class="block text-sm text-gray-600 dark:text-gray-400">Gasolio</label>
                                                <input type="number" step="0.001" x-model.number="newCompetitorPrices[competitor].gasolio" class="mt-1 text-right w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveCompetitorPrices()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button type="button" @click="closeConcorrenzaModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isNuovoClienteModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isNuovoClienteModalOpen" @click="closeNewClientModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isNuovoClienteModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="user-plus" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" x-text="editingClient ? 'Modifica Cliente' : 'Nuovo Cliente'"></h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome Cliente</label>
                                    <input type="text" x-model="newClient.name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Saldo Iniziale</label>
                                    <input type="number" step="0.01" x-model.number="newClient.balance" :disabled="editingClient" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md disabled:bg-gray-200 dark:disabled:bg-gray-600">
                                     <p x-show="!editingClient" class="text-xs text-gray-500 mt-1">Lasciare vuoto o 0 per iniziare con un saldo nullo. Usare valori positivi per un credito del cliente e valori negativi per un debito.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveClient()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button x-show="editingClient" type="button" @click="deleteClient(editingClient)" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Elimina
                    </button>
                    <button type="button" @click="closeNewClientModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isContoClienteModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isContoClienteModalOpen" @click="closeContoClienteModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isContoClienteModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                
                <div class="no-print">
                    <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <template x-if="contoCliente">
                            <div>
                                <div class="flex justify-between items-start">
                                     <div>
                                        <h3 class="text-2xl font-bold text-gray-900 dark:text-white" x-text="contoCliente.name"></h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Riepilogo conto cliente</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Saldo Attuale</p>
                                        <p class="text-3xl font-bold" :class="getClientBalanceClass(contoCliente.balance)" x-text="formatCurrency(contoCliente.balance)"></p>
                                    </div>
                                </div>
                                <div class="mt-6 flex flex-col lg:flex-row gap-8">
                                    <div class="w-full lg:w-1/3">
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Nuova Operazione</h4>
                                        <div class="space-y-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                                                <input type="text" x-model="newTransaction.date" placeholder="gg-mm-aaaa" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrizione</label>
                                                <input type="text" x-model="newTransaction.description" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Importo (€)</label>
                                                <input type="number" step="0.01" x-model.number="newTransaction.amount" placeholder="Es. 50.00" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                            </div>
                                            <div class="space-y-2 pt-2 border-t dark:border-gray-600">
                                                <button @click="addTransaction()" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                                    Aggiungi Spesa
                                                </button>
                                                <button @click="addAcconto()" class="w-full text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                                    Aggiungi Acconto
                                                </button>
                                            </div>
                                            <div class="space-y-2 pt-2 border-t dark:border-gray-600">
                                                <button @click="saldaConto()" class="w-full text-gray-900 bg-yellow-400 hover:bg-yellow-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                                    Salda Conto
                                                </button>
                                                <button @click="stampaDati()" class="w-full text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                                                    Stampa Conto
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full lg:w-2/3">
                                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Storico Operazioni</h4>
                                        <div class="max-h-96 overflow-y-auto pr-2">
                                            <div x-show="sortedTransactions.length === 0" class="text-center py-10 text-gray-500 dark:text-gray-400">
                                                <i data-lucide="receipt" class="w-12 h-12 mx-auto mb-2"></i>
                                                <p>Nessuna operazione registrata.</p>
                                            </div>
                                            <ul class="space-y-3">
                                                <template x-for="tx in sortedTransactions" :key="tx.id">
                                                    <li class="p-3 rounded-lg bg-gray-50 dark:bg-gray-900/50">
                                                        <template x-if="editingTransaction && editingTransaction.id === tx.id">
                                                            <div class="space-y-2">
                                                                <div class="flex items-center gap-2">
                                                                    <input type="text" x-model="editingTransaction.date" class="text-sm w-1/4 p-1 rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                                                    <input type="text" x-model="editingTransaction.description" class="text-sm w-2/4 p-1 rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                                                    <input type="number" step="0.01" x-model.number="editingTransaction.amount" class="text-sm w-1/4 p-1 rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-right">
                                                                </div>
                                                                <div class="flex justify-end gap-2">
                                                                    <button @click="saveTransaction()" class="text-xs text-white bg-green-600 hover:bg-green-700 px-2 py-1 rounded">Salva</button>
                                                                    <button @click="cancelEditTransaction()" class="text-xs text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 px-2 py-1 rounded">Annulla</button>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        <template x-if="!editingTransaction || editingTransaction.id !== tx.id">
                                                            <div class="flex justify-between items-center">
                                                                <div class="flex items-center gap-3">
                                                                    <i :data-lucide="tx.description === 'Acconto' ? 'plus-circle' : 'minus-circle'" class="w-5 h-5" :class="tx.description === 'Acconto' ? 'text-green-500' : 'text-red-500'"></i>
                                                                    <div>
                                                                        <p class="font-medium text-gray-800 dark:text-gray-200" x-text="tx.description"></p>
                                                                        <p class="text-sm text-gray-500 dark:text-gray-400" x-text="formatDate(tx.date)"></p>
                                                                    </div>
                                                                </div>
                                                                <div class="flex items-center gap-3">
                                                                    <p class="font-semibold" :class="tx.description === 'Acconto' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'" x-text="(tx.description === 'Acconto' ? '+' : '-') + formatCurrency(tx.amount)"></p>
                                                                    <div class="flex items-center">
                                                                        <button @click="editTransaction(tx)" class="p-1 text-gray-500 hover:text-blue-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                                                            <i data-lucide="square-pen" style="width: 16px; height: 16px;"></i>
                                                                        </button>
<button @click="deleteTransaction(tx)" class="p-1 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                                                        <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </li>
                                                </template>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" @click="closeContoClienteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                            Chiudi
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
<div x-show="isNuovoTurnoModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isNuovoTurnoModalOpen" @click="closeNuovoTurnoModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isNuovoTurnoModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="clock" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" x-text="editingTurno ? 'Modifica Turno' : 'Nuovo Turno'"></h3>
                             <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                                    <input type="text" x-model="newTurno.date" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Turno</label>
                                    <input type="text" x-model="newTurno.turno" placeholder="Es. A, B, C..." class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50 space-y-3">
                                    <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200">IPERSELF</h4>
                                    <div class="grid grid-cols-2 gap-x-3 gap-y-2">
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Gasolio</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.iperself.gasolio" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Diesel+</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.iperself.dieselPlus" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Benzina</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.iperself.benzina" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">HVOlution</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.iperself.hvolution" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50 space-y-3">
                                    <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200">SERVITO</h4>
                                    <div class="grid grid-cols-2 gap-x-3 gap-y-2">
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Gasolio</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.servito.gasolio" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Diesel+</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.servito.dieselPlus" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                         <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">Benzina</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.servito.benzina" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">HVOlution</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.servito.hvolution" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div class="text-center col-start-2">
                                            <label class="block text-sm text-gray-600 dark:text-gray-400">AdBlue</label>
                                            <input type="number" step="0.01" x-model.number="newTurno.servito.adblue" class="mt-1 w-full text-right shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveTurno()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button type="button" @click="closeNuovoTurnoModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isNewContactModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isNewContactModalOpen" @click="closeNewContactModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isNewContactModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="user-plus" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" x-text="editingContact ? 'Modifica Contatto' : 'Nuovo Contatto'"></h3>
                            <div class="mt-4 space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome</label>
                                        <input type="text" x-model="newContact.firstName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cognome <span class="text-xs text-red-500">(obbligatorio)</span></label>
                                        <input type="text" x-model="newContact.lastName" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Telefono</label>
                                        <input type="tel" x-model="newContact.phone" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">E-mail</label>
                                        <input type="email" x-model="newContact.email" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Organizzazione</label>
                                        <input type="text" x-model="newContact.organization" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Note</label>
                                        <input type="text" x-model="newContact.notes" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Etichette</label>
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <template x-for="label in contactLabels" :key="label.id">
                                            <button @click="toggleLabel(label.id)" 
                                                    class="flex items-center text-sm rounded-full py-1 px-3 border transition-colors"
                                                    :class="{ 'bg-blue-600 text-white border-blue-600': newContact.labels.includes(label.id), 'bg-gray-100 text-gray-700 border-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600': !newContact.labels.includes(label.id) }"
                                                    >
                                                <span class="w-2 h-2 rounded-full mr-2" :style="'background-color: ' + label.color"></span>
                                                <span x-text="label.name"></span>
                                            </button>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" @click="saveContact()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Salva
                    </button>
                    <button type="button" @click="closeNewContactModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isGestisciEtichetteModalOpen" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="isGestisciEtichetteModalOpen" @click="closeGestisciEtichetteModal()" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90 transition-opacity"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="isGestisciEtichetteModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="tags" class="h-6 w-6 text-blue-600 dark:text-blue-300"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Gestisci Etichette</h3>
                            <div class="mt-4 space-y-4">
                                <div class="space-y-2 max-h-48 overflow-y-auto pr-2">
                                    <template x-for="label in contactLabels" :key="label.id">
                                        <div class="flex items-center justify-between p-2 rounded-md bg-gray-100 dark:bg-gray-700/50">
                                            <div class="flex items-center gap-2">
                                                <span class="w-4 h-4 rounded-full" :style="'background-color: ' + label.color"></span>
                                                <span class="text-gray-900 dark:text-gray-200" x-text="label.name"></span>
                                            </div>
                                            <button @click="deleteLabel(label.id)" class="text-gray-500 hover:text-red-600">
                                                <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <div class="border-t border-gray-200 dark:border-gray-700 pt-4" x-show="contactLabels.length < 5">
                                    <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-2">Aggiungi nuova etichetta</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome</label>
                                            <input type="text" x-model="newLabel.name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Colore</label>
                                            <div class="flex gap-3">
                                                <template x-for="color in availableColors" :key="color.value">
                                                    <label class="flex items-center cursor-pointer">
                                                        <input type="radio" :value="color.value" x-model="newLabel.color" class="sr-only">
                                                        <div class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center transition-all"
                                                             :style="'background-color: ' + color.value"
                                                             :class="{ 'ring-2 ring-offset-2 ring-blue-500': newLabel.color === color.value }">
                                                            <div x-show="newLabel.color === color.value" class="w-2 h-2 bg-white rounded-full"></div>
                                                        </div>
                                                    </label>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button x-show="contactLabels.length < 5" type="button" @click="saveNewLabel()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:ml-3 sm:w-auto sm:text-sm">
                        Aggiungi
                    </button>
                    <button type="button" @click="closeGestisciEtichetteModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div x-show="isNotificationModalOpen" class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div x-show="isNotificationModalOpen" @click="isNotificationModalOpen = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90"></div>
            <div x-show="isNotificationModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-90" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-sm w-full z-10 text-center">
                <i data-lucide="info" class="mx-auto h-12 w-12 text-blue-500"></i>
                <p class="mt-4 text-gray-700 dark:text-gray-300" x-text="notificationMessage"></p>
                <button @click="isNotificationModalOpen = false" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <div x-show="isConfirmationModalOpen" class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen">
            <div x-show="isConfirmationModalOpen" @click="isConfirmationModalOpen = false" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900 bg-opacity-90"></div>
            <div x-show="isConfirmationModalOpen" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-90" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 m-4 max-w-sm w-full z-10">
                <div class="text-center">
                    <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-yellow-500"></i>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mt-2">Conferma Azione</h3>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400" x-text="confirmationMessage"></p>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button @click="confirmAction()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:col-start-2 sm:text-sm">
                        Conferma
                    </button>
                    <button @click="isConfirmationModalOpen = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>